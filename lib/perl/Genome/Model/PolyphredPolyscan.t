#!/gsc/bin/perl

use strict;
use warnings;

use above 'Genome';
use Test::More skip_all => 'update once composite_member relationship has been replaced with to_ and from_ models';
use File::Path;

$ENV{UR_DBI_NO_COMMIT} = 1;
$ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;

my $test_dir = '/gsc/var/cache/testsuite/data/Genome-Model-PolyphredPolyscan/';
my $pp_data_dir = "/tmp/test_polyphredpolyscan_$ENV{USER}/";
my $test_build_dir = "/gsc/var/cache/testsuite/data/Genome-Model-PolyphredPolyscan/test.TCGA_Production.polyphred.high";

my $cv_data_dir = "/tmp/test_polyphredpolyscan_cv_$ENV{USER}/";
my $research_project_name = "test_research_project";
my $sensitivity = 'low';
my $technology_type = 'polyphred';
my $subject_name = 'polyphredpolyscan_unit_test';
my $pp_model_name = "test.TCGA_Production.polyphred.high";
my $cv_model_name = "test.TCGA_Production.combine.variants";

my $new_combine_variants_model = Genome::Model::CombineVariants->create(
    name => $cv_model_name,
    subject_name    =>  $subject_name,
    subject_type    => 'sample_group',
    data_directory  =>  $cv_data_dir,
);

ok($new_combine_variants_model, "Created the new combine variants model explicitly for the new PolyphredPolyscan models");
isa_ok($new_combine_variants_model, "Genome::Model::CombineVariants");

# Create the polyphredpolyscan model
my $model = Genome::Model::PolyphredPolyscan->get_or_create(
    model_name => $pp_model_name,
    research_project => $research_project_name,
    technology => $technology_type,
    sensitivity => $sensitivity,
    subject_name => $subject_name,
    data_directory => $pp_data_dir,
    parent_model_id => $new_combine_variants_model->id,
);

# Check stuff
isa_ok($model, "Genome::Model::PolyphredPolyscan");

my $model_directory = $model->data_directory;
ok(-d $model_directory, "model_directory $model_directory exists");

my $pending_input_dir = $model->pending_instrument_data_dir;
ok(-d $pending_input_dir, "pending input dir $pending_input_dir exists");

# Check methods
is($model->build_subclass_name, 'polyphred polyscan', 'build subclass is correct');
is($model->resolve_data_directory, "/gscmnt/834/info/medseq/polyphred_polyscan//$pp_model_name/", 'resolve_data_directory works as expected');
ok(-d $model->pending_instrument_data_dir, "pending instrument data dir exists");
ok(-d $model->source_instrument_data_dir, "source instrument data dir exists");

# Change the data directory so we can use premade test data
ok($model->data_directory($test_dir), "Changed the test dir to premade data");
ok(-d $model->data_directory, "Test directory exists");

# test predict_genotype
# test next_pcr_product_genotype ... will need test data 
# test next_sample_genotype... will need test data 
# test pending_instrument_data_files... will need test data 

# clean up
END {
    rmtree($pp_data_dir);
    rmtree($cv_data_dir);
}



#! /gsc/bin/perl

use strict;
use warnings;

use above 'Genome';

require File::Compare;
use Genome::Model::MetagenomicComposition16s::Test;
use Test::More;

$ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
$ENV{UR_DBI_NO_COMMIT} = 1;

use_ok('Genome::Model::Event::Build::MetagenomicComposition16s::PrepareInstrumentData::Sanger') or die;

# model/builds
my $model = Genome::Model::MetagenomicComposition16s::Test->model_for_sanger;
ok($model, 'got mc16s sanger model') or die;
my $build = Genome::Model::Build->create(
    model => $model,
    data_directory => $model->data_directory,
);
ok($build, 'created build') or die;
my $example_build = Genome::Model::Build->create(
    model=> $model,
    data_directory => '/gsc/var/cache/testsuite/data/Genome-Model/MetagenomicComposition16sSanger/build',
);
ok($example_build, 'example build') or die;

# run
my $pid = Genome::Model::Event::Build::MetagenomicComposition16s::PrepareInstrumentData::Sanger->create(build => $build);
ok($pid, 'create');
$pid->dump_status_messages(1);
ok($pid->execute, 'execute');

# verify
my @amplicon_sets = $build->amplicon_sets;
is(@amplicon_sets, 1, 'amplicon_sets');
my ($example_amplicon_set) = $example_build->amplicon_sets;

ok(-s $amplicon_sets[0]->processed_fasta_file, 'processed fasta file');
is(
    File::Compare::compare($amplicon_sets[0]->processed_fasta_file, $example_amplicon_set->processed_fasta_file), 
    0,
    'processed amplicon fasta file matches',
);
ok(-s $amplicon_sets[0]->processed_qual_file, 'processed qual file');
is(
    File::Compare::compare($amplicon_sets[0]->processed_qual_file, $example_amplicon_set->processed_qual_file), 
    0,
    'processed amplicon qual file matches',
);

while ( my $amplicon = $amplicon_sets[0]->next_amplicon ) {
    ok(-s $build->scfs_file_for_amplicon($amplicon), 'scfs file');
    ok(-s $build->phds_file_for_amplicon($amplicon), 'phds file');
    ok(-s $build->reads_fasta_file_for_amplicon($amplicon), 'fasta file');
    ok(-s $build->reads_qual_file_for_amplicon($amplicon), 'qual file');
    ok(-s $build->ace_file_for_amplicon($amplicon), 'ace file');
}

ok(-s $build->raw_reads_fasta_file, 'Created the raw reads fasta file');
# Time diffs prevent comparing files. Maybe update the desc for these reads
#is(File::Compare::compare($build->raw_reads_fasta_file, $example_build->raw_reads_fasta_file), 0, 'raw reads fasta file matches');
ok(-s $build->raw_reads_qual_file, 'Created the raw reads qual file');

ok(-s $build->processed_reads_fasta_file, 'Created the processed reads fasta file');
# Time diffs prevent comparing files. Maybe update the desc for these reads
#is(File::Compare::compare($build->processed_reads_fasta_file, $example_build->processed_reads_fasta_file), 0, 'processed reads fasta file matches');
ok(-s $build->processed_reads_qual_file, 'Created the processed reads qual file');

# metrics
is($build->amplicons_attempted, 5, 'amplicons attempted is 5');
is($build->reads_attempted, 30, 'reads attempted is 30');
is($build->reads_processed, 17, 'reads processed is 17');
is($build->reads_processed_success, '0.57', 'reads processed success is 0.57');

#print $build->data_directory."\n";<STDIN>;
done_testing();  
exit;



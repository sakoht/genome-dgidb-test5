#!/usr/bin/env perl

use strict;
use warnings;

use above "Genome";
use Test::More;
use File::Compare;

$ENV{UR_DBI_NO_COMMIT} = 1;
$ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;

BEGIN {
    my $archos = `uname -a`;
    if ($archos !~ /64/) {
        plan skip_all => "Must run from 64-bit machine";
    } else {
        plan tests => 10;
    }
};

use_ok( 'Genome::Model::Tools::DetectVariants2::Combine::UnionSv');

my $test_data_dir     = '/gsc/var/cache/testsuite/data/Genome-Model-Tools-DetectVariants2-Combine-UnionSv';
my $refbuild_id       = 109104543;
my $tumor_bam_file    = $test_data_dir . '/tumor.bam';
my $normal_bam_file   = $test_data_dir . '/normal.bam';
my $input_directory_a = $test_data_dir . '/breakdancer_inter_tigra';
my $input_directory_b = $test_data_dir . '/breakdancer_intra_tigra';
my $expected_output   = $test_data_dir . '/expected_output_dir';

my $test_output_dir = File::Temp::tempdir(
    'Genome-Model-Tools-DetectVariants2-Combine-UnionSv-XXXXX', 
    DIR     => '/gsc/var/cache/testsuite/running_testsuites', 
    CLEANUP => 1,
);

my $union_sv_object = Genome::Model::Tools::DetectVariants2::Combine::UnionSv->create(
    input_directory_a           => $input_directory_a,
    input_directory_b           => $input_directory_b,
    aligned_reads_input         => $tumor_bam_file,
    control_aligned_reads_input => $normal_bam_file,
    output_directory            => $test_output_dir,
    reference_build_id          => $refbuild_id,
);

ok($union_sv_object, 'created UnionSv object');
ok($union_sv_object->execute(), 'executed UnionSv object');

my @files = ('svs.hq');
for my $type qw(Inter Intra) {
    push @files, map{$type.'.svs.merge.'.$_}qw(fasta file out);
}

for my $file (@files) {
    my $test_output     = $test_output_dir.'/'.$file;
    my $expected_output = $expected_output.'/'.$file;
    is(compare($test_output,$expected_output),0, "Found no difference for $file between test and expected output");
}


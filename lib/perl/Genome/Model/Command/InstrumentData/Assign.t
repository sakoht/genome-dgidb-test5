#!/usr/bin/env perl

use strict;
use warnings;

use above 'Genome';

use Data::Dumper 'Dumper';
use Test::More;
use Test::MockObject;

$ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
$ENV{UR_DBI_NO_COMMIT} = 1;

use_ok('Genome::Model::Command::InstrumentData::Assign') or die;

my $pp = Genome::ProcessingProfile::TestPipeline->create(
    name => 'Test Pipeline Test for Testing',
    some_command_name => 'ls',
);
ok($pp, "created processing profile") or die;

my $model = Genome::Model->create(
    processing_profile => $pp,
    subject_name => 'human',
    subject_type => 'species_name',
    user_name => 'apipe',
);
ok($model, 'create model') or die;

my @sanger_id = map { Genome::InstrumentData::Sanger->create(id => '0'.$_.'jan00.101amaa') } (1..4);
is(@sanger_id, 4, 'create instrument data') or die;
no warnings qw/once redefine/;
*Genome::ModelDeprecated::compatible_instrument_data = sub{ return @sanger_id; };
use warnings;
my @compatible_id = $model->compatible_instrument_data;
is_deeply(\@sanger_id, \@compatible_id, 'overload compatible instrument data');

my $flow_cell = Genome::InstrumentData::FlowCell->create(id => '__TEST_FLOW_CELL__');
ok($flow_cell, 'create flow cell') or die;
my $solexa_id = Genome::InstrumentData::Solexa->create(flow_cell_id => $flow_cell->id);
ok($solexa_id, 'create solexa inst data') or die;
is_deeply([ $flow_cell->lanes ], [ $solexa_id ], 'got lanes from flow cell');
my $index_illumina = Test::MockObject->new(); # this is a LIMs module, so using mock
ok($index_illumina, 'create index illumina') or die;
$index_illumina->set_true('copy_sequence_files_confirmed_successfully');
ok($index_illumina->copy_sequence_files_confirmed_successfully, 'copy seq files succeeded') or die;
no warnings qw/once redefine/;
*Genome::InstrumentData::Solexa::index_illumina = sub{ return $index_illumina; };
use warnings;
is_deeply($solexa_id->index_illumina, $index_illumina, 'overload index_illumina') or die;

my ($assign, @assigned_inst_data);

# Fails
$assign = Genome::Model::Command::InstrumentData::Assign->create(
    model_id => $model->id,
    all => 1,
    instrument_data_ids => '44 44',
);
ok($assign, 'create to request multiple functions - will fail execute');
$assign->dump_status_messages(1);
ok(!$assign->execute, 'execute');

# Sucess
$assign = Genome::Model::Command::InstrumentData::Assign->create(
    model_id => $model->id,
    instrument_data_id => $sanger_id[0]->id,
    force => 1,
);
ok($assign, 'create to assign single instrument data');
$assign->dump_status_messages(1);
ok($assign->execute, 'execute');
@assigned_inst_data = $model->instrument_data;
is_deeply(\@assigned_inst_data, [ $sanger_id[0], ], 'confirmed assigned inst data');

$assign = Genome::Model::Command::InstrumentData::Assign->create(
    model_id => $model->id,
    instrument_data_ids => join( ' ', $sanger_id[1]->id, $sanger_id[2]->id, ),
    force => 1,
);
ok($assign, 'create to assign multiple instrument data');
$assign->dump_status_messages(1);
ok($assign->execute, 'execute');
@assigned_inst_data = $model->instrument_data;
is_deeply(\@assigned_inst_data, [ @sanger_id[0..2], ], 'confirmed assigned inst data');

$assign = Genome::Model::Command::InstrumentData::Assign->create(
    model_id => $model->id,
    all => 1,
);
ok($assign, 'create to assign all available instrument data');
$assign->dump_status_messages(1);
ok($assign->execute, 'execute');
@assigned_inst_data = $model->instrument_data;
is_deeply(\@assigned_inst_data, \@sanger_id, 'confirmed assigned inst data');

#Add an ignored InstrumentData, and make sure Assign --all doesn't grab it.
Genome::InstrumentData::Sanger->create(id => '05.jan00.101amaa');

$assign = Genome::Model::Command::InstrumentData::Assign->create(
    model_id => $model->id,
    all => 1,
);
ok($assign, 'create to assign all available instrument data');
$assign->dump_status_messages(1);
ok($assign->execute, 'execute');
@assigned_inst_data = $model->instrument_data;
is_deeply(\@assigned_inst_data, \@sanger_id, 'confirmed skip ignored  inst data');


$assign = Genome::Model::Command::InstrumentData::Assign->create(
    model_id => $model->id,
    flow_cell_id => $solexa_id->flow_cell_id,
    force => 1,
);
ok($assign, 'create to assign by flow cell id');
$assign->dump_status_messages(1);

# Mock copy sequence files pse and its status
my $copy_sequence_pse = Test::MockObject->new;
$copy_sequence_pse->mock('pse_status', sub { 'inprogress' });
$index_illumina->mock('get_copy_sequence_files_pse', sub { $copy_sequence_pse });

ok($assign->execute, 'execute');
@assigned_inst_data = $model->instrument_data;
is_deeply(\@assigned_inst_data, [ @sanger_id, $solexa_id ], 'confirmed assigned inst data');

note('Reassign inst data is ok');
$assign = Genome::Model::Command::InstrumentData::Assign->create(
    model_id => $model->id,
    instrument_data_id => $sanger_id[0]->id,
    force => 1,
);
ok($assign, 'create to reassign single instrument data');
$assign->dump_status_messages(1);
ok($assign->execute, 'execute');

done_testing();
exit;


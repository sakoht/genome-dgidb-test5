#!/usr/bin/env perl

use strict;
use warnings;

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
};

use above 'Genome';

use Test::More tests => 8;

use_ok('Genome::Model::Command::Define::ImportedVariationList');

my $ref = Genome::Model::Build::ReferenceSequence->get_by_name('NCBI-human-build36');
my $sample = Genome::Sample->create(
    name => 'test_sample_for_ivl_test',
    common_name => 'tumor',
);

my $snv_file_path = Genome::Sys->create_temp_file_path;
Genome::Sys->write_file(
    $snv_file_path,
    "1	33	34	A/T\n"
);
my $snv_result = Genome::Model::Tools::DetectVariants2::Result::Manual->create(
    original_file_path => $snv_file_path,
    description => 'snv test',
    variant_type => 'snv',
    format => 'bed',
    reference_build_id => $ref->id,
    sample_id => $sample,
);

my $indel_file_path = Genome::Sys->create_temp_file_path;
Genome::Sys->write_file(
    $indel_file_path,
    "1	33	34	A/*\n"
);
my $indel_result = Genome::Model::Tools::DetectVariants2::Result::Manual->create(
    original_file_path => $indel_file_path,
    description => 'indel test',
    variant_type => 'indel',
    format => 'bed',
    reference_build_id => $ref->id,
    sample_id => $sample,
);

my $sv_file_path = Genome::Sys->create_temp_file_path;
Genome::Sys->write_file(
    $sv_file_path,
    "<fake file>\n"
);
my $sv_result = Genome::Model::Tools::DetectVariants2::Result::Manual->create(
    original_file_path => $sv_file_path,
    description => 'sv test',
    variant_type => 'sv',
    format => 'breakdancer',
    reference_build_id => $ref->id,
    sample_id => $sample,
);

my $cnv_file_path = Genome::Sys->create_temp_file_path;
Genome::Sys->write_file(
    $cnv_file_path,
    "<fake file>\n"
);
my $cnv_result = Genome::Model::Tools::DetectVariants2::Result::Manual->create(
    original_file_path => $cnv_file_path,
    description => 'cnv test',
    variant_type => 'cnv',
    format => 'test',
    reference_build_id => $ref->id,
    sample_id => $sample,
);

my $cmd = Genome::Model::Command::Define::ImportedVariationList->create(
    version => 'awesome',
    prefix => 'IVL_model_test',
    snv_result => $snv_result,
    indel_result => $indel_result,
    sv_result => $sv_result,
    cnv_result => $cnv_result,
);
isa_ok($cmd, 'Genome::Model::Command::Define::ImportedVariationList', 'created command');
$cmd->dump_status_messages(1);
$cmd->dump_error_messages(1);
ok($cmd->execute, 'executed command');

my $build = $cmd->build;
isa_ok($build, 'Genome::Model::Build::ImportedVariationList', 'created build');

for my $type ('snv', 'indel', 'sv', 'cnv') {
    my $accessor = $type . '_result';
    is(eval('$' . $accessor), $build->$accessor, "$accessor matches expected value");
}

#! /gsc/bin/perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
};

use strict;
use warnings;

use above 'Genome';

use Test::More;

use_ok('Genome::Model::Command::Copy') or die;

my $sample = Genome::Sample->create(name => '__TEST_SAMPLE_1__');
my $model = Genome::Model->get(2862809551); # apipe-test-04-ref_align
ok($model, 'model');
$model->target_region_set_name('BULLS_EYE');
is($model->target_region_set_name, 'BULLS_EYE', 'set target region set name');
my $copy = Genome::Model::Command::Copy->create( # use 37 instead of 36
    model => $model,
    overrides => [ 
        'name=__COPY_TEST1__',
        'subject='.$sample->id,
        'processing_profile=name="Feb 2011 Default Reference Alignment"', 
        'reference_sequence_build=102671028',
        'dbsnp_build=id=106375969',
        'annotation_reference_build=',  
        'target_region_set_name=',
        'instrument_data=',
    ],
);
ok($copy, 'create');
$copy->dump_status_messages(1);
ok($copy->execute, 'execute');
my $new_model = Genome::Model->get(name => '__COPY_TEST1__');
ok($new_model, 'copied model');
is_deeply($new_model->subject, $sample, 'override subject');
is($new_model->processing_profile->id, 2580856, 'override pp id');
is($new_model->reference_sequence_build->id, 102671028, 'override ref seq build');
ok(!$new_model->annotation_reference_build, 'undef annotation build');
ok(!$new_model->annotation_reference_build_id, 'undef annotation build id');
is($new_model->dbsnp_build->id, 106375969, 'override dbsnp build');
ok(!$new_model->target_region_set_name, 'undef target region set name');
is_deeply([$new_model->instrument_data], [], 'did not copy inst data');

my $rv = system(qq(genome model copy 2862809551 name=__COPY_TEST2__ processing_profile='name="Feb 2011 Default Reference Alignment"' target_region_set_name='CAMBRIDGE'));
is($rv, 0, 'command line');

done_testing();
exit;


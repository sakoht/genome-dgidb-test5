#!/gsc/bin/perl

use strict;
use warnings;

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use above 'Genome';

use Test::More tests => 10;

use_ok('Genome::Model::Command::Services::BuildQueuedModels');

my $processing_profile = Genome::ProcessingProfile::ReferenceAlignment->create(
    dna_type => 'genomic dna',
    name => 'AQID-test-pp',
    read_aligner_name => 'bwa',
    sequencing_platform => 'solexa',
    read_aligner_params => '#this is a test',
);

my $taxon = Genome::Taxon->get( species_name => 'human' );

my $reference_sequence_build = Genome::Model::Build::ImportedReferenceSequence->get_by_name('NCBI-human-build36');
ok($reference_sequence_build, 'got reference sequence build') or die;

my $model_1 = Genome::Model::ReferenceAlignment->create(
    id => '-100',
    reference_sequence_build => $reference_sequence_build,
    name => 'bqm-test-1',
    processing_profile_id => $processing_profile->id,
    subject_id => $taxon->id,
    subject_class_name => $taxon->class,
    build_requested => 1,
);

my $model_2 = Genome::Model::ReferenceAlignment->create(
    id => '-101',
    reference_sequence_build => $reference_sequence_build,
    name => 'bqm-test-2',
    processing_profile_id => $processing_profile->id,
    subject_id => $taxon->id,
    subject_class_name => $taxon->class,
    build_requested => 1,
);

my $model_3 = Genome::Model::ReferenceAlignment->create(
    id => '-102',
    reference_sequence_build => $reference_sequence_build,
    name => 'bqm-test-3',
    processing_profile_id => $processing_profile->id,
    subject_id => $taxon->id,
    subject_class_name => $taxon->class,
    build_requested => 0,
);

my $command_1 = Genome::Model::Command::Services::BuildQueuedModels->create(
    test => 1,
);
isa_ok($command_1, 'Genome::Model::Command::Services::BuildQueuedModels');
ok($command_1->execute(), 'executed build command');

is($command_1->_builds_started, 2, 'started builds for the two applicable models');
ok(!$model_1->build_requested, 'build no longer requested for model');
ok(!$model_2->build_requested, 'build no longer requested for model');

my $command_2 = Genome::Model::Command::Services::BuildQueuedModels->create(
    test => 1,
);
isa_ok($command_2, 'Genome::Model::Command::Services::BuildQueuedModels');
ok($command_2->execute(), 'executed build command');

is($command_2->_builds_started, 0, 'started no builds since no applicable models');

#!/usr/bin/env perl

use strict;
use warnings;

use above 'Genome';

require File::Temp;
use Test::More;

$ENV{UR_DBI_NO_COMMIT} = 1;
$ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;

use_ok('Genome::Model::Command::Services::Build::Run') or die;

my $tmpdir = File::Temp::tempdir(CLEANUP => 1);
my $model = Genome::Model->create(
    name => 'Build Run Test',
    processing_profile_id => 2268394, # test pipeline: ssmith-testppX
    subject_type => 'species_name',
    subject_name => 'human',
    data_directory => $tmpdir,
);
ok($model, 'create model');
my $build = Genome::Model::Build->create(
    id => -7777,
    model => $model,
    data_directory => $model->data_directory,
);
ok($build, 'create build');

no warnings qw/ once redefine /;
*Genome::Model::Build::generate_send_and_save_report = sub{  return 1; };
#*Genome::Model::Build::newest_workflow_instance = sub{  return; };
use warnings;

ok($build->_initialize_workflow, 'init work flow');

my $run = Genome::Model::Command::Services::Build::Run->create(
    model_id => $model->id,
    build_id => $build->id,
    inline => 1,
);
ok($run, 'create');
$run->dump_status_messages(1);
ok($run->execute, 'execute');
is($build->status, 'Succeeded', 'build is succeeded');

done_testing();
exit;


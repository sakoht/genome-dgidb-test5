#!/usr/bin/env perl

use strict;
use warnings;

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use above 'Genome';

use Data::Dumper;
use Test::More;

use_ok('Genome::Model::Command::Services::AssignQueuedInstrumentData') or die;

my $taxon = Genome::Taxon->get(name => 'Human Metagenome');
ok($taxon, 'got human metagenome taxon');
my $ps = GSC::ProcessStep->get( process_to => 'queue instrument data for genome modeling' );
ok($ps, 'got qidfgm process step');
my $pp = Genome::ProcessingProfile->get(2571784);
ok($pp, 'got mc16s pp');
my (@samples, @instrument_data, @pses);
for my $i (1..2) {
    ok(_qidfgm(), 'create qidfgm');
}
is(@instrument_data, 2, 'create 2 inst data');
is(@pses, 2, 'create 2 pses');

my $gsc_workorder = GSC::Setup::WorkOrder->create(
    setup_name => 'AQID-TEST-WORKORDER',
    project_id => '-4',
    pse_id => '-10000000',
    pipeline => '16S 454',
);
isa_ok($gsc_workorder, 'GSC::Setup::WorkOrder');
my $gsc_project = GSC::Setup::Project::Research->create(
    id => -4,
    setup_name => 'AQID-TEST-PROJECT',
    pse_id => '-10000001',
);
isa_ok($gsc_project, 'GSC::Setup::Project::Research');
no warnings;
sub GSC::PSE::QueueInstrumentDataForGenomeModeling::get_inherited_assigned_directed_setups_filter_on {
    my $self = shift;
    my $filter = shift;
    my @a;
    push @a, $gsc_workorder if $filter eq 'setup work order';
    push @a, $gsc_project if $filter eq 'setup project';
    return @a;
}

sub GSC::Setup::WorkOrder::get_project {
    my $self = shift;
    return $gsc_project;
}
use warnings;

my $cmd = Genome::Model::Command::Services::AssignQueuedInstrumentData->create(
    test => 1,
);
ok($cmd, 'create aqid');
$cmd->dump_status_messages(1);
ok($cmd->execute, 'execute');
my @new_models = values %{$cmd->_newly_created_models};
my %new_models = _model_hash(@new_models);
my @existing_models = values %{$cmd->_existing_models_assigned_to};
my %existing_models = _model_hash(@existing_models);
#print Dumper(\%new_models,\%existing_models);
my $model_name_for_entire_run = "R_2011_07_27_14_54_40_FLX08080419_Administrator_113684816_r1.prod-mc16s-qc";
is_deeply(
    \%new_models,
    {
        "AQID-testsample1.prod-metagenomic_composition_16s" => {
            subject => $samples[0]->name,
            processing_profile_id => Genome::Model::Command::Services::AssignQueuedInstrumentData->_default_mc16s_processing_profile_id,
            inst => [ $instrument_data[0]->id ],
            auto_assign_inst_data => 1,
        },
        "AQID-testsample2.prod-metagenomic_composition_16s" => {
            subject => $samples[1]->name,
            processing_profile_id => Genome::Model::Command::Services::AssignQueuedInstrumentData->_default_mc16s_processing_profile_id,
            inst => [ $instrument_data[1]->id ],
            auto_assign_inst_data => 1,
        },
        $model_name_for_entire_run => {
            subject => "Human Metagenome",
            processing_profile_id => Genome::Model::Command::Services::AssignQueuedInstrumentData->_default_mc16s_processing_profile_id,
            inst => [ map { $_->id } @instrument_data ],
            auto_assign_inst_data => 0,
        },
    },
    'new models for run 1',
);
is_deeply(
    \%existing_models, 
    { $model_name_for_entire_run => $new_models{$model_name_for_entire_run} },
    'existing models for run 1',
);
my @projects = Genome::Project->get('name in' => [ map { $_->setup_name } $gsc_project, $gsc_workorder ]);
is(@projects, 2, 'created projects');
is_deeply(
    [ sort { $a <=> $b } map { $_->id } @projects ],
    [ sort { $a <=> $b } map { $_->id } ($gsc_project, $gsc_workorder) ],
    'project ids match gsc entity ids',
);
my @model_groups = Genome::ModelGroup->get(uuid => [ map { $_->id } @projects ]);
is(@model_groups, 2, 'created model groups');

ok(_qidfgm(), 'made another qdidfgm');
is(@instrument_data, 3, '3 inst data');
is(@pses, 3, '3 pses');

$cmd = Genome::Model::Command::Services::AssignQueuedInstrumentData->create(
    test => 1,
);
ok($cmd, 'create aqid');
$cmd->dump_status_messages(1);
ok($cmd->execute, 'execute');
@new_models = values %{$cmd->_newly_created_models};
%new_models = _model_hash(@new_models);
@existing_models = values %{$cmd->_existing_models_assigned_to};
%existing_models = _model_hash(@existing_models);
#print Dumper(\%new_models,\%existing_models);
is_deeply(
    \%new_models,
    {
        "AQID-testsample3.prod-metagenomic_composition_16s" => {
            subject => $samples[2]->name,
            processing_profile_id => Genome::Model::Command::Services::AssignQueuedInstrumentData->_default_mc16s_processing_profile_id,
            inst => [ $instrument_data[2]->id ],
            auto_assign_inst_data => 1,
        },
    },
    'new models for run 2',
);
is_deeply(
    \%existing_models,
    {
        $model_name_for_entire_run => {
            subject => "Human Metagenome",
            processing_profile_id => Genome::Model::Command::Services::AssignQueuedInstrumentData->_default_mc16s_processing_profile_id,
            inst => [ map { $_->id } @instrument_data ],
            auto_assign_inst_data => 0,
        },
    },
    'existing models for run 2',
);

done_testing();
exit;

my $i = 0;
sub _qidfgm {
    $i++;
    my $sample = Genome::Sample->create(
        name => 'AQID-testsample'.$i,
        taxon_id => $taxon->id,
        extraction_type => 'genomic',
    );
    ok($sample, 'create sample '.$i);
    push @samples, $sample;
    my $library = Genome::Library->create(
        name => $sample->name.'-lib1',
        sample_id => $sample->id,
    );
    ok($library, 'create library '.$i);

    my $instrument_data = Genome::InstrumentData::454->create(
        library_id => $library->id,
        run_name => 'R_2011_07_27_14_54_40_FLX08080419_Administrator_113684816',
        region_number => 1,
    );
    ok($instrument_data, 'created instrument data '.$i);
    push @instrument_data, $instrument_data;

    my $pse = GSC::PSE::QueueInstrumentDataForGenomeModeling->create(
        pse_status => 'inprogress',
        pse_id => $i - 10000,
        ps_id => $ps->ps_id,
        ei_id => '464681',
    );
    ok($pse, 'create pse '.$i);
    $pse->add_param('instrument_data_type', '454');
    $pse->add_param('instrument_data_id', $instrument_data->id);
    $pse->add_param('subject_class_name', 'Genome::Sample');
    $pse->add_param('subject_id', $sample->id);
    $pse->add_param('processing_profile_id', $pp->id);
    push @pses, $pse;
    return 1;
}

sub _model_hash {
    return map { 
        $_->name => { 
            subject => $_->subject_name, 
            processing_profile_id => $_->processing_profile_id,
            inst => [ map { $_->id } $_->instrument_data ],
            auto_assign_inst_data => $_->auto_assign_inst_data,
        }
    } @_;
}


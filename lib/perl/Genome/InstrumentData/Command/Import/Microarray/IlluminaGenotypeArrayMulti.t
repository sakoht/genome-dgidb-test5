#!/usr/bin/env perl

use strict;
use warnings;

use above "Genome";

use Test::More;

if (Genome::Config->arch_os ne 'x86_64') {
    plan skip_all => 'requires 64-bit machine';
}

$ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = "1";
$ENV{UR_DBI_NO_COMMIT} = "1";

use_ok('Genome::InstrumentData::Command::Import::Microarray::IlluminaGenotypeArrayMulti') or die;

UR::DataSource->next_dummy_autogenerated_id;
do {
    $UR::DataSource::last_dummy_autogenerated_id = int($UR::DataSource::last_dummy_autogenerated_id / 10);
} until length($UR::DataSource::last_dummy_autogenerated_id) < 9;
diag('Dummy ID: '.$UR::DataSource::last_dummy_autogenerated_id);
cmp_ok(length($UR::DataSource::last_dummy_autogenerated_id), '<',  9, 'dummy id is shorter than 9 chars');

my $reference = Genome::Model::Build::ImportedReferenceSequence->get(name => 'NCBI-human-build36');
ok($reference, 'got refseq build');

my $source_dir = '/gsc/var/cache/testsuite/data/Genome-InstrumentData-Command-Import-Microarray/test_files/multi/iScan';
ok(-d $source_dir, "our example directory exists");
my $cmd = Genome::InstrumentData::Command::Import::Microarray::IlluminaGenotypeArrayMulti->create(
    original_data_path => $source_dir,
    reference_sequence_build => $reference,
    description => 'ISCAN genotyper data',
);
ok($cmd, "constructed an import command");
$cmd->dump_status_messages(1);
my @errors = $cmd->__errors__;
is(scalar(@errors),0, "no errors in cmd");
ok($cmd->execute, "iScan data passed testing");

my $models = $cmd->_models;
is(@$models, 1, 'created models');
my $build = $models->[0]->last_succeeded_build;
ok($build, 'got build');
my $snp_array_file = $build->formatted_genotype_file_path;
ok(-s $snp_array_file, 'created snp array file');
my $snvs_bed = $build->snvs_bed;
ok(-s $snvs_bed, 'created snvs bed file');

my $source_dir2 = '/gsc/var/cache/testsuite/data/Genome-InstrumentData-Command-Import-Microarray/test_files/multi/comma'; 
ok(-d $source_dir2, "our example directory 2 exists");
my $cmd2 = Genome::InstrumentData::Command::Import::Microarray::IlluminaGenotypeArrayMulti->create(
    original_data_path => $source_dir2,
    reference_sequence_build => $reference,
    description => 'Comma genotyper data',
);
ok($cmd2, "constructed an import command");
$cmd2->dump_status_messages(1);
my @errors2 = $cmd2->__errors__;
is(scalar(@errors2),0, "no errors in cmd");
ok($cmd2->execute, "execution was successful");
$models = $cmd2->_models;
is(@$models, 1, 'created models');
$build = $models->[0]->last_succeeded_build;
ok($build, 'got build');
$snp_array_file = $build->formatted_genotype_file_path;
ok(-s $snp_array_file, 'created snp array file');
$snvs_bed = $build->snvs_bed;
ok(-s $snvs_bed, 'created snvs bed file');

done_testing();
exit;


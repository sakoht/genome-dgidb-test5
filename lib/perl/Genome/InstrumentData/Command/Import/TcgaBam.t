#!/usr/bin/env perl

use strict;
use warnings;

$ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = "1";
$ENV{UR_DBI_NO_COMMIT} = "1";

use above "Genome";
use Test::More;

UR::DataSource->next_dummy_autogenerated_id;
do {
    $UR::DataSource::last_dummy_autogenerated_id = int($UR::DataSource::last_dummy_autogenerated_id / 10);
} until length($UR::DataSource::last_dummy_autogenerated_id) < 9;
diag('Dummy ID: '.$UR::DataSource::last_dummy_autogenerated_id);
cmp_ok(length($UR::DataSource::last_dummy_autogenerated_id), '<',  9, 'dummy id is shorter than 9 chars');

my $tcga_name = "TCGA-AB-2804-03B-01W-0728-08";

my $i = Genome::InstrumentData::Command::Import::TcgaBam->create(
    target_region       => 'none',
    tcga_name           => $tcga_name,  
    import_source_name  => 'Broad',
    original_data_path  => '/gsc/var/cache/testsuite/data/Genome-InstrumentData--Command-Import-Bam/test.bam',
);

ok($i, "Import Bam Command created ok");
$i->dump_status_messages(1);
ok($i->execute,"Test Bam is imported ok");

note "instrument data id is ". $i->import_instrument_data_id."\n";

my $i_d = Genome::InstrumentData::Imported->get($i->import_instrument_data_id);
is($i_d->sequencing_platform,'solexa','platform is correct');
is($i_d->user_name, $ENV{USER}, "user name is correct");
ok($i_d->description,"description was created: ".$i_d->description);
ok($i_d->import_date, "date is set");
ok(-s $i_d->disk_allocations->absolute_path.'/all_sequences.bam', "bam exists");

my $ok;
eval { $ok = UR::Context->_sync_databases(); };
ok($ok, "saves to the database!");

done_testing(9);
exit;

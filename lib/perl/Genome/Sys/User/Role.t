#!/usr/bin/perl

BEGIN { 
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use strict;
use warnings;

use above "Genome";
use Test::More;

use_ok('Genome::Sys::User::Role') or die;
use_ok('Genome::Sys::User::RoleMember') or die;
use_ok('Genome::Sys::User') or die;

my $test_role_name = 'testing123';

my $role = Genome::Sys::User::Role->create(
    name => $test_role_name,
);
ok($role, 'able to create role with just a name');

# Create dupliate, make sure it returns an error from __errors__
my $duplicate_role = Genome::Sys::User::Role->create(
    name => $test_role_name,
);
ok($duplicate_role, 'able to create role with same name');

my @tags = $duplicate_role->__errors__;
ok(@tags, 'got error tags when calling __errors__ on duplicate role');
ok(@tags == 1, 'got only one tag on duplicate role, as expected');
ok($tags[0]->desc =~ /user role already exists with name $test_role_name/, 'tag description indicates role is a duplicate');

# Try to delete duplicate
my $rv = $duplicate_role->delete;
ok($rv, 'deletion of duplicate role returned 1, as expected');
ok($duplicate_role->isa('UR::DeletedRef'), 'duplicate rule object is now a deleted ref, as expected');

# Create test user
my $user = Genome::Sys::User->create(
    email => 'testing1234@example.com',
    name => 'testing 1234',
);
ok($user, 'created test user');

# Try to add user to test role
$rv = $role->add_user($user);
ok($rv, 'add user method returned success');

my $bridge = Genome::Sys::User::RoleMember->get(
    role => $role,
    user => $user,
);
ok($bridge, 'retrieved bridge entity');

# Try to delete role when a user is using it
$rv = eval { $role->delete };
my $error = $@;
ok($error, 'could not delete role when it has users, as expected');
ok($error =~ /Cannot delete user role $test_role_name/, 'error message matches expected pattern');

# Remove role from user
$rv = $bridge->delete;
ok($rv, 'user/role bridge object delete returned success');
ok($bridge->isa('UR::DeletedRef'), 'deleted bridge entity is a UR::DeletedRef, as expected');

# Attempt to delete the role again
$rv = $role->delete;
ok($rv, 'deletion of role returned success');
ok($role->isa('UR::DeletedRef'), 'role is a UR::DeletedRef, as expected');

done_testing();





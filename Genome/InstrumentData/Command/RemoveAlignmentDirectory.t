#!/gsc/bin/perl

use strict;
use warnings;

use Test::More tests => 8;
use File::Copy;

use above 'Genome';

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    use_ok('Genome::InstrumentData::Command::RemoveAlignmentDirectory');
}

my $mock_data = '/gsc/var/cache/testsuite/data/Genome-Model-Tools-Maq-AlignReads/all_sequences.bfa';

my $tmp_dir = File::Temp::tempdir('Genome-InstrumentData-RemoveAlignmentDirectory-XXXXX', DIR => '/gsc/var/cache/testsuite/running_testsuites', CLEANUP => 1);
# TODO: Create an allocation and fake data directory
my $instrument_data = Genome::InstrumentData->create_mock(
                                                          id => UR::DataSource->next_dummy_autogenerated_id,
                                                          sequencing_platform => 'mock_sequencing_platform',
                                                          sample_name => 'mock_sample_name',
                                                      );
isa_ok($instrument_data,'Genome::InstrumentData');

$instrument_data->mock('remove_alignment_directory_for_aligner_and_refseq',
                       \&Genome::InstrumentData::remove_alignment_directory_for_aligner_and_refseq);

my $allocator_id = UR::DataSource->next_dummy_autogenerated_id;
my $allocation = Genome::Disk::Allocation->create_mock(
                                                       id => $allocator_id,
                                                       allocator_id => $allocator_id,
                                                       disk_group_name => 'mock_disk_group',
                                                       kilobytes_requested => 100000,
                                                       kilobytes_used => 0,
                                                       mount_path => $tmp_dir,
                                                       allocation_path => 'test_directory',
                                                       group_subdirectory => 'test_subdirectory',
                                                       owner_class_name => 'Test::MockObject',
                                                       owner_id => $$,
                                                   );
isa_ok($allocation,'Genome::Disk::Allocation');
$allocation->set_always('absolute_path',$tmp_dir .'/'. $allocation->group_subdirectory .'/'. $allocation->allocation_path);
$allocation->set_always('deallocate',1);

ok(Genome::Utility::FileSystem->create_directory($allocation->absolute_path),'created directory '. $allocation->absolute_path);
ok(copy($mock_data,$allocation->absolute_path.'/test.dat'),'copy test data');
$instrument_data->set_always('alignment_allocation_for_aligner_and_refseq',$allocation);

# TODO: run the command to remove the alignment directory and allocation
my $remove_cmd = Genome::InstrumentData::Command::RemoveAlignmentDirectory->create(
                                                                                   instrument_data_id => $instrument_data->id,
                                                                                   aligner_name => 'test_read_aligner',
                                                                                   reference_sequence_name => 'test_ref_seq',
                                                                               );
isa_ok($remove_cmd,'Genome::InstrumentData::Command::RemoveAlignmentDirectory');
ok($remove_cmd->execute,'execute remove command '. $remove_cmd->command_name);
ok(!-d $allocation->absolute_path,'alignment directory '. $allocation->absolute_path .' has been removed');

exit;

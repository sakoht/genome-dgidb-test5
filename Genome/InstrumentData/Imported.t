#!/usr/bin/env perl
use strict;
use warnings;
use above "Genome";
use Test::More tests => 21;
$ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = "1";
$ENV{UR_DBI_NO_COMMIT} = "1";

my $s = Genome::Sample->get(2824113569);

my $i = Genome::InstrumentData::Imported->create(
    id => -123,
    sample_name             => $s->name,  
    sample_id               => $s->id, 
    import_source_name      => 'Broad',
    original_data_path      => '/tmp/foo',
    import_format           => 'BAM',
    sequencing_platform     => 'solexa',
    description             => 'big ugly bwa file',
    read_count              => 1000,
    base_count              => 100000,
);

ok($i, "created a new imported instrument data");
isa_ok($i,"Genome::InstrumentData::Imported");
is($i->id,-123, "id is set");
is($i->sequencing_platform,'solexa','platform is correct');
is($i->user_name, $ENV{USER}, "user name is correct");
ok($i->import_date, "date is set");

#print Data::Dumper::Dumper($i);

my $i2 = Genome::InstrumentData::Imported->create(
    id => -456,
    sample_name             => $s->name,  
    sample_id               => $s->id, 
    import_source_name      => 'Broad',
    original_data_path      => '/tmp/nst',
    import_format           => 'BAM',
    sequencing_platform     => '454',
    description             => 'big ugly bwa file',
    read_count              => 1000,
    base_count              => 100000,
);

ok($i2, "created a new imported instrument data");
isa_ok($i2,"Genome::InstrumentData::Imported");
is($i2->id, -456, "id is set");
is($i2->sequencing_platform,'454','platform is correct');
is($i2->user_name, $ENV{USER}, "user name is correct");
ok($i2->import_date, "date is set");


# Test Imported.pm against fastq data
my $s3 = Genome::Sample->get(2824113551);

my $i3 = Genome::InstrumentData::Imported->create(
    id => -789,
    sample_name             => $s3->name,  
    sample_id               => $s3->id, 
    import_source_name      => 'Broad',
    original_data_path      => '/gsc/var/cache/testsuite/data/Genome-InstrumentData-Command-Import-Fastq/s_5_1_sequence.txt,/gsc/var/cache/testsuite/data/Genome-InstrumentData-Command-Import-Fastq/s_5_2_sequence.txt',
    import_format           => 'fastq',
    sequencing_platform     => 'solexa',
    description             => 'fastq import test',
    read_count              => 1000,
    base_count              => 100000,
);

ok($i3, "created a new imported instrument data");
isa_ok($i3,"Genome::InstrumentData::Imported");
is($i3->id,-789, "id is set");
is($i3->sequencing_platform,'solexa','platform is correct');
is($i3->user_name, $ENV{USER}, "user name is correct");
is($i3->import_format, "fastq","import format = fastq");
is($i3->original_data_path, "/gsc/var/cache/testsuite/data/Genome-InstrumentData-Command-Import-Fastq/s_5_1_sequence.txt,/gsc/var/cache/testsuite/data/Genome-InstrumentData-Command-Import-Fastq/s_5_2_sequence.txt", "original_data_path matches");
is($i3->calculate_alignment_estimated_kb_usage, "585", "estimated kb usage is correct");


my $ok;
eval { $ok = UR::Context->_sync_databases(); };
ok($ok, "saves to the database!");

#UR::Context->commit;
#call $instrument_data->delete to delete


#!/gsc/bin/perl

use strict;
use warnings;

use Test::More tests => 16;

use GSCApp;
App::DB->db_access_level('rw');
App::DB::TableRow->use_dummy_autogenerated_ids(1);
App::DBI->no_commit(1);
App->init;

use above "Genome";

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    use_ok('Genome::InstrumentData');
    use_ok('Genome::InstrumentData::454');
    use_ok('Genome::InstrumentData::Sanger');
    use_ok('Genome::InstrumentData::Solexa');
};

my %seq_plats_and_ids = (
    454     => '2403581188',
    sanger  => '03may05.868pmaa1',
    solexa  => '2338813239',
);

my @rcs = Genome::InstrumentData->get([ values %seq_plats_and_ids ]);
is(scalar(@rcs), 3, "got 3 objects");

my $solexa_instrument_data = Genome::InstrumentData->get(2338813239);
isa_ok($solexa_instrument_data,'Genome::InstrumentData::Solexa');

my $alignment_path = $solexa_instrument_data->resolve_alignment_path_for_aligner_and_refseq('test_aligner','test_reference_name');
is($alignment_path,'alignment_data/test_aligner/test_reference_name/070827_HWI-EAS110_0000_11228/1_2338813239','got expected alignment path');

my $alignment_allocation = $solexa_instrument_data->alignment_allocation_for_aligner_and_refseq('test_aligner','test_reference_name',check_only => 1);
ok(!$alignment_allocation,'no disk allocation for alignment directory');

my $alignment_directory = $solexa_instrument_data->alignment_directory_for_aligner_and_refseq('test_aligner','test_reference_name',check_only => 1);
is($alignment_directory,'/gscmnt/839/info/medseq/alignment_links/test_aligner/test_reference_name/070827_HWI-EAS110_0000_11228/1_2338813239',
   'got expected alignment directory');

$alignment_allocation = $solexa_instrument_data->alignment_allocation_for_aligner_and_refseq('test_aligner','test_reference_name');
isa_ok($alignment_allocation,'Genome::Disk::Allocation');

$alignment_directory = $solexa_instrument_data->alignment_directory_for_aligner_and_refseq('test_aligner','test_reference_name',check_only => 1);
is($alignment_directory,$alignment_allocation->absolute_path,'got the alignment directory based on the disk allocation');




# Test the methods that have exceptions for external data

my $external_solexa_instrument_data = Genome::InstrumentData->get(2738233262);
isa_ok($external_solexa_instrument_data,'Genome::InstrumentData::Solexa');
ok($external_solexa_instrument_data->is_external,'got external solexa instrument data');


my $external_alignment_path = $external_solexa_instrument_data->resolve_alignment_path_for_aligner_and_refseq('test_aligner','test_reference_name');
is($external_alignment_path,'alignment_data/test_aligner/test_reference_name/2738233262/1_2738233262','got expected external alignment path');

my $external_alignment_allocation = $external_solexa_instrument_data->alignment_allocation_for_aligner_and_refseq('test_aligner','test_reference_name',check_only => 1);
ok(!$external_alignment_allocation,'no disk allocation for external alignment directory');

my $external_alignment_directory = $external_solexa_instrument_data->alignment_directory_for_aligner_and_refseq('test_aligner','test_reference_name',check_only => 1);
is($external_alignment_directory,'/gscmnt/839/info/medseq/alignment_links/test_aligner/test_reference_name/2738233262/1_2738233262',
   'got expected external alignment directory');

#$HeadURL$
#$Id$

package Genome::ProcessingProfile::AmpliconAssembly::Test;

use strict;
use warnings;

$ENV{UR_DBI_NO_COMMIT} = 1;
$ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;

use base 'Test::Class';

use Data::Dumper 'Dumper';
use Test::More;

sub test_dir {
    return '/gsc/var/cache/testsuite/data/Genome-ProcessingProfile-AmpliconAssembly';
}

sub _valid_params {
    return (
        name => '18S Composition 18SEUKF to 18SEUKR (502F, 1174R)',
        assembler => 'phredphrap',
        assembly_size => 1900,
        primer_amp_forward => '18SEUKF:ACCTGGTTGATCCTGCCAG',
        primer_amp_reverse => '18SEUKR:TGATCCTTCYGCAGGTTCAC',
        primer_seq_forward => '502F:GGAGGGCAAGTCTGGT',
        primer_seq_reverse => '1174R:CCCGTGTTGAGTCAAA',
        purpose => 'composition',
        region_of_interest => '18S',
        sequencing_center => 'gsc',
        sequencing_platform => 'sanger',
    );
}

#< MOCK ># 
sub create_mock_processing_profile {
    my $self = shift;

    my $pp = Genome::ProcessingProfile::AmpliconAssembly->create_mock( 
        id => -50000,
        processing_profile_id => -50000,
        _valid_params(),
    )
        or die "Can't create mock processing profile for amplicon assembly\n";

    $pp->set_list('params_for_class', Genome::ProcessingProfile::AmpliconAssembly->params_for_class);
    $pp->set_always('sense_primer_fasta', test_dir().'/sense.fasta');
    die "No sense primer fasta in ".test_dir()."\n" unless -f $pp->sense_primer_fasta;
    $pp->set_always('anti_sense_primer_fasta', test_dir().'/anti_sense.fasta');
    die "No anti sense primer fasta in ".test_dir()."\n" unless -f $pp->anti_sense_primer_fasta;

    return $pp;
}

#< VALID - CREATES A REAL PP >#
sub test001_create_processing_profile : Test(4) {
    my $self = shift;

    use_ok('Genome::ProcessingProfile::AmpliconAssembly');
    my $pp = Genome::ProcessingProfile::AmpliconAssembly->create( _valid_params() );
    ok($pp, 'Created amplicon assembly processing profile');
    isa_ok($pp, 'Genome::ProcessingProfile::AmpliconAssembly');
    isa_ok($pp, 'Genome::ProcessingProfile');

    return $pp;
}

#< INVALID >#
sub test002_invalid_params : Test(14) {
    my $self = shift;

    my %params = _valid_params();
    for my $param ( Genome::ProcessingProfile::AmpliconAssembly->params_for_class) {
        my $valid_value = delete $params{$param}; # save to ad back
        unless ( Genome::ProcessingProfile::AmpliconAssembly->param_is_optional($param) ) {
            # No param...
            ok(
                ! Genome::ProcessingProfile::AmpliconAssembly->create(%params),
                "Failed as expected - w/o $param",
            );
        }

        if ( Genome::ProcessingProfile::AmpliconAssembly->valid_values_for_param($param) ) {
            # Invalid param...
            $params{$param} = 'Not a valid value for a parameter';
            ok( 
                ! Genome::ProcessingProfile::AmpliconAssembly->create(%params),
                "Failed as expected - w/ an invalid value for $param",
            );
        }

        # Reset value
        $params{$param} = $valid_value;
    }

    #< Primers >#
    # none
    for ( keys %params ) { delete $params{$_} if /primer/; }
    ok( 
        ! Genome::ProcessingProfile::AmpliconAssembly->create(%params),
        "Failed as expected - w/o any primers",
    );
    # invlaid (no primer name)
    $params{primer_amp_forward} = 'AAGGTGAGCCCGCGATGCGAGCTTAT';
    ok( 
        ! Genome::ProcessingProfile::AmpliconAssembly->create(%params),
        "Failed as expected - w/ invalid primer string",
    );

    return 1;
}

1;

#$HeadURL$
#$Id$

#! /gsc/bin/perl

use warnings;
use strict; 
#use Test::More tests=> 170;
use Test::More skip_all => "Broken from GSC/PSE change. Skipping until this is remedied.";

use Genome;

$ENV{UR_DBI_NO_COMMIT} = 1;
$ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;

use Workflow::Simple;
$Workflow::Simple::override_lsf_use = 1;

use GSCApp;
App::DB->db_access_level('rw');
App::DB::TableRow->use_dummy_autogenerated_ids(1);
App->init();

my $q = q/
select tp.pse_id from tpp_pse tp
where tp.prior_pse_id in(
select api.pse_id from assembly_project_item@dw api
join assembly_project@dw ap on ap.asp_id = api.asp_id
where ap.assembly_project_name =  ? and rownum =1)/;

my $asp_name = 'TCGA_Production-0005156_017-Ensembl-46_36h';

# Explicitly create the combine variants model this ONCE to be retreived later

my $subject_name = "detect_sequence_variation_test";
my $combine_variants_data_directory = "/tmp/test_combine_variants_$ENV{USER}/";

my $pp = Genome::ProcessingProfile::CombineVariants->create(
    name => 'test-detect-sequence-variation',
);
my $new_combine_variants_model = Genome::Model::CombineVariants->create(
    name => 'test-detect-sequence-variation',
    processing_profile_id   => $pp->id,
    subject_name            =>  $subject_name,  #TODO this has changed
    subject_type            => 'sample_group',
    data_directory          =>  $combine_variants_data_directory,
);
ok($new_combine_variants_model, "Created the new combine variants model explicitly for the new PolyphredPolyscan models");
isa_ok($new_combine_variants_model, "Genome::Model::CombineVariants");

my @directories_to_cleanup;
my @detect_seq_var_pses;
my $asp = GSC::AssemblyProject->get(assembly_project_name => $asp_name);
ok($asp, "got assembly project");

my $project_dir = "/gsc/var/cache/testsuite/data/Genome-detectsequencevariation/$asp_name";

my $sth = App::DB->dbh->prepare($q);
$sth->execute($asp_name);

my $ref = $sth->fetchall_arrayref;
ok(($ref and @$ref), "got a update mp assembly pse");
my $control_pse_id = $ref->[0]->[0];
my (@variances, @variances_fs, $snps, $indels, $ps, $ps1,$setup, $ids, $ds, $pps, $pse1, $pse,$tp, $ao, $out_obj, $sample_pos_snp_hash, $sample_pos_indel_hash, $shin_polyphred_out, $shin_obj, $data_directory );
my $shin_storage = '/gscmnt/temp113/finishing/scratch/detect_sequence_variation_test_data';

$setup = GSC::Setup::SequenceAnalysis->get(setup_name => 'Default Detect and Evaluate Sequence Variation');
ok($setup, "got setup");
$ds = GSC::DirectedSetup->get(setup_id => $setup->id);
ok($ds, "got ds");

$ids = GSC::InheritedDirectedSetup->get(pse_id=> $control_pse_id , ds_id => $ds->id);
unless ($ids){
    $ids = GSC::InheritedDirectedSetup->create(pse_id=> $control_pse_id , ds_id => $ds->id);
}
ok($ids, "created inherited ds");

$ps = GSC::ProcessStep->get(process_to => 'detect sequence variation');
ok($ps, "got ps detect");

($tp) = GSC::ProcessStepTransferPattern->get(ps_id => $ps->id);
ok($tp, "got tp");

#polyphred s 1 10##########################################################
$pps = GSC::ProcessParamSet->get(ps_id => $ps->id, pps_name => 'polyphred s 1 10');
ok($pps, "got process param set");

$pse1 = $ps->init_pse;
ok($pse1, "inited pse");

ok( $pse1->add_param_tp_id($tp->tp_id), "added tp_id");
ok( $pse1->add_param(control_pse_id => $control_pse_id), "added control_pse_id");
ok( $pse1->add_param(asp_id => $asp->asp_id), "added asp_id");
ok( $pse1->add_param(project_dir => $project_dir), "added /gsc/var/cache/testsuite dir");
ok( $pse1->add_param(pps_id => $pps->id), "added pps_id");
ok( $pse1->add_param(model_id => $new_combine_variants_model->id), "added model id");
ok( $pse1->confirmable, "confirmable");
ok( $pse1->confirm, "confirmed");
push @detect_seq_var_pses, $pse1;

my $bridge = GSC::Sequence::AnalysisOutputPSE->get(pse_id => $pse1->id);
ok($bridge, "got analysis_output_pse");
 
my $file = $pse1->output_file_name;
ok (-e $file, "$file exists");
$out_obj = $pse1->get_output_file_object($file);
ok (ref $out_obj, "got out obj");

($snps, $indels) =$out_obj->collate_sample_group_mutations;
@variances = (@$snps, @$indels);
ok(@variances, "collatted");

#polyphred s 1 25##########################################################
$pps = GSC::ProcessParamSet->get(ps_id => $ps->id, pps_name => 'polyphred s 1 25');
ok($pps, "got process param set");

$pse1 = $ps->init_pse;
ok($pse1, "inited pse");

ok( $pse1->add_param_tp_id($tp->tp_id), "added tp_id");
ok( $pse1->add_param(control_pse_id => $control_pse_id), "added control_pse_id");
ok( $pse1->add_param(asp_id => $asp->asp_id), "added asp_id");
ok( $pse1->add_param(project_dir => $project_dir), "added /gsc/var/cache/testsuite dir");
ok( $pse1->add_param(pps_id => $pps->id), "added pps_id");
ok( $pse1->add_param(model_id => $new_combine_variants_model->id), "added model id");
ok( $pse1->confirmable, "confirmable");
ok( $pse1->confirm, "confirmed");

$bridge = GSC::Sequence::AnalysisOutputPSE->get(pse_id => $pse1->id);
ok($bridge, "got analysis_output_pse");

push @detect_seq_var_pses, $pse1;

$file = $pse1->output_file_name;
ok (-e $file, "$file exists");
$out_obj = $pse1->get_output_file_object($file);
ok (ref $out_obj, "got out obj");

($snps, $indels) =$out_obj->collate_sample_group_mutations;
@variances = (@$snps, @$indels);
ok(@variances, "collatted");

#polyscan s 1 10##########################################################

$pps = GSC::ProcessParamSet->get(ps_id => $ps->id, pps_name => 'polyscan s 1 10');
ok($pps, "got process param set");

$pse = $ps->init_pse;
ok($pse, "inited pse");

ok( $pse->add_param_tp_id($tp->tp_id), "added tp_id");
ok( $pse->add_param(control_pse_id => $control_pse_id), "added control_pse_id");
ok( $pse->add_param(asp_id => $asp->asp_id), "added asp_id");
ok( $pse->add_param(pps_id => $pps->id), "added pps_id");
ok( $pse->add_param(project_dir => $project_dir), "added /gsc/var/cache/testsuite dir");
ok( $pse->add_param(model_id => $new_combine_variants_model->id), "added model id");
ok( $pse->confirmable, "confirmable");
ok( $pse->confirm, "confirmed");
push @detect_seq_var_pses, $pse;

$bridge = GSC::Sequence::AnalysisOutputPSE->get(pse_id => $pse->id);
ok($bridge, "got analysis_output_pse");

$file = $pse->output_file_name;
ok (-e $file, "$file exists");
$out_obj = $pse->get_output_file_object($file);
ok (ref $out_obj, "got out obj");

($snps, $indels) =$out_obj->collate_sample_group_mutations;
@variances = (@$snps, @$indels);
ok(@variances, "collatted");

#polyscan s 1 25##########################################################

$pps = GSC::ProcessParamSet->get(ps_id => $ps->id, pps_name => 'polyscan s 1 25');
ok($pps, "got process param set");

$pse = $ps->init_pse;
ok($pse, "inited pse");

ok( $pse->add_param_tp_id($tp->tp_id), "added tp_id");
ok( $pse->add_param(control_pse_id => $control_pse_id), "added control_pse_id");
ok( $pse->add_param(asp_id => $asp->asp_id), "added asp_id");
ok( $pse->add_param(project_dir => $project_dir), "added /gsc/var/cache/testsuite dir");
ok( $pse->add_param(pps_id => $pps->id), "added pps_id");
ok( $pse->add_param(model_id => $new_combine_variants_model->id), "added model id");
ok( $pse->confirmable, "confirmable");
ok( $pse->confirm, "confirmed");
push @detect_seq_var_pses, $pse;

$bridge = GSC::Sequence::AnalysisOutputPSE->get(pse_id =>  $pse->id);
ok($bridge, "got analysis_output_pse");

$file = $pse->output_file_name;
ok (-e $file, "$file exists");

$out_obj = $pse->get_output_file_object($file);
ok (ref $out_obj, "got out obj");

($snps, $indels) =$out_obj->collate_sample_group_mutations;
@variances = (@$snps, @$indels);
ok(@variances, "collatted");

###########################################################################
###########################################################################
#Evaluate Sequence Variation
#POLYSCAN EVALUATIVE s 1 10
ok(@detect_seq_var_pses == 4, "got four prior pses"); 

$ps1 = GSC::ProcessStep->get(process_to => 'evaluate sequence variation');
ok($ps1, "got ps evaluate");

my $pse2 = $ps1->init_pse;
ok($pse2, "inited pse");


$pps = GSC::ProcessParamSet->get(ps_id => $ps1->id, pps_name => 'polyscan s 1 10');
ok($pps, "got process param set");

ok( $pse2->add_param_tp_id($tp->tp_id), "added tp_id");
ok( $pse2->add_param(control_pse_id => [map{$_->id}@detect_seq_var_pses]), "added prior_pse_ids");
ok( $pse2->add_param(asp_id => $asp->asp_id), "added asp_id");
ok( $pse2->add_param(project_dir => $project_dir), "added /gsc/var/cache/testsuite dir");
ok( $pse2->add_param(pps_id => $pps->id), "added pps_id");
ok( $pse2->add_param(model_id => $new_combine_variants_model->id), "added model id");
ok( $pse2->confirmable, "confirmable");
ok( $pse2->confirm, "confirmed");

$bridge = GSC::Sequence::AnalysisOutputPSE->get(pse_id => $pse2->id);
ok($bridge, "got analysis_output_pse");


# Check the next step
ok( $pse2->post_confirm, "post_confirm");
$bridge = GSC::Sequence::AnalysisOutputPSE->get(pse_id => $pse2->id);
ok($bridge, "got analysis_output_pse");


my ($tpp_bridge_2) = GSC::TppPSE->get(prior_pse_id => $pse2->id);
ok ($tpp_bridge_2, "got the bridge");
my ($next_pse_2) = GSC::PSE->get($tpp_bridge_2->pse_id);
isa_ok ($next_pse_2, "GSC::PSE::QueueInstrumentDataForGenomeModeling");
$data_directory = "/tmp/test_polyscan_evaluative_1_10_$ENV{USER}/";

ok($next_pse_2->add_param('data_directory', $data_directory), "added data directory param: $data_directory to pse");
ok($next_pse_2->add_param('subject_name', $subject_name), "added test subject name $subject_name to pse");
ok($next_pse_2->confirm, "Called confirm");

ok($next_pse_2->post_confirm, "Called post_confirm");

$file = $pse2->output_file_name;
ok (-e $file, "$file exists");
$out_obj = $pse2->get_output_file_object($file);
ok (ref $out_obj, "got out obj");

($snps, $indels) =$out_obj->collate_sample_group_mutations;
@variances = (@$snps, @$indels);
ok(@variances, "collatted");


Storable::lock_nstore \@variances, "/gscuser/sabbott/polyphred_read_grop.ser";
#####################################
#POLYSCAN EVALUATIVE s 1 25 
ok(@detect_seq_var_pses == 4, "got four prior pses"); 

$pps = GSC::ProcessParamSet->get(ps_id => $ps1->id, pps_name => 'polyscan s 1 25');
ok($pps, "got process param set");

my $pse3 = $ps1->init_pse;
ok($pse3, "inited pse");
ok( $pse3->add_param_tp_id($tp->tp_id), "added tp_id");
ok( $pse3->add_param(control_pse_id => [map{$_->id}@detect_seq_var_pses]), "added prior_pse_ids");
ok( $pse3->add_param(asp_id => $asp->asp_id), "added asp_id");
ok( $pse3->add_param(project_dir => $project_dir), "added /gsc/var/cache/testsuite dir");
ok( $pse3->add_param(pps_id => $pps->id), "added pps_id");
ok( $pse3->add_param(model_id => $new_combine_variants_model->id), "added model id");
ok( $pse3->confirmable, "confirmable");
ok( $pse3->confirm, "confirmed");
$bridge = GSC::Sequence::AnalysisOutputPSE->get(pse_id => $pse3->id);
ok($bridge, "got analysis_output_pse");

# Check the next step
ok( $pse3->post_confirm, "post_confirm");
my ($tpp_bridge_3) = GSC::TppPSE->get(prior_pse_id => $pse3->id);
ok ($tpp_bridge_3, "got the bridge");
my ($next_pse_3) = GSC::PSE->get($tpp_bridge_3->pse_id);
isa_ok ($next_pse_3, "GSC::PSE::QueueInstrumentDataForGenomeModeling");
$data_directory = "/tmp/test_polyscan_evaluative_1_25_$ENV{USER}/";
ok($next_pse_3->add_param('data_directory', $data_directory), "added data directory param:$data_directory to pse");
ok($next_pse_3->add_param('subject_name', $subject_name), "added test subject name $subject_name to pse");
ok($next_pse_3->confirm, "Called confirm");

ok($next_pse_3->post_confirm, "Called post_confirm");

$file = $pse3->output_file_name;
ok (-e $file, "$file exists");
$out_obj = $pse3->get_output_file_object($file);
ok (ref $out_obj, "got out obj");

($snps, $indels) =$out_obj->collate_sample_group_mutations;
@variances = (@$snps, @$indels);
ok(@variances, "collatted");


################################################################################
#POLYPHRED ForceGenotype s 1 10
$pps = GSC::ProcessParamSet->get(ps_id => $ps1->id, pps_name => 'polyphred s 1 10');
ok($pps, "got process param set");

$pse2 = $ps1->init_pse;
ok($pse2, "inited pse");
ok( $pse2->add_param_tp_id($tp->tp_id), "added tp_id");
ok( $pse2->add_param(control_pse_id => [map{$_->id}@detect_seq_var_pses]), "added prior_pse_ids");
ok( $pse2->add_param(asp_id => $asp->asp_id), "added asp_id");
ok( $pse2->add_param(pps_id => $pps->id), "added pps_id");
ok( $pse2->add_param(project_dir => $project_dir), "added /gsc/var/cache/testsuite dir");
ok( $pse2->add_param(model_id => $new_combine_variants_model->id), "added model id");


ok( $pse2->confirmable, "confirmable");
ok( $pse2->confirm, "confirmed");
$bridge = GSC::Sequence::AnalysisOutputPSE->get(pse_id => $pse2->id);
ok($bridge, "got analysis_output_pse");

# Check the next step
ok( $pse2->post_confirm, "post_confirm");
($tpp_bridge_2) = GSC::TppPSE->get(prior_pse_id => $pse2->id);
ok ($tpp_bridge_2, "got the bridge");
($next_pse_2) = GSC::PSE->get($tpp_bridge_2->pse_id);
isa_ok ($next_pse_2, "GSC::PSE::QueueInstrumentDataForGenomeModeling");
$data_directory = "/tmp/test_polyphred_force_genotype_1_10_$ENV{USER}/";
ok($next_pse_2->add_param('data_directory', $data_directory), "added data directory param:$data_directory to pse");
ok($next_pse_2->add_param('subject_name', $subject_name), "added test subject name $subject_name to pse");
ok($next_pse_2->confirm, "Called confirm");
ok($next_pse_2->post_confirm, "Called post_confirm");

$file = $pse2->output_file_name;
ok (-e $file, "$file exists");
$out_obj = $pse2->get_output_file_object($file);
ok (ref $out_obj, "got out obj");

($snps, $indels) =$out_obj->collate_sample_group_mutations;
@variances = (@$snps, @$indels);
ok(@variances, "collatted");

################################################################################
#POLYPHRED ForceGenotype s 1 25 
$pps = GSC::ProcessParamSet->get(ps_id => $ps1->id, pps_name => 'polyphred s 1 25');
ok($pps, "got process param set");

$pse2 = $ps1->init_pse;
ok($pse2, "inited pse");
ok( $pse2->add_param_tp_id($tp->tp_id), "added tp_id");
ok( $pse2->add_param(control_pse_id => [map{$_->id}@detect_seq_var_pses]), "added prior_pse_ids");
ok( $pse2->add_param(asp_id => $asp->asp_id), "added asp_id");
ok( $pse2->add_param(project_dir => $project_dir), "added /gsc/var/cache/testsuite dir");
ok( $pse2->add_param(pps_id => $pps->id), "added pps_id");
ok( $pse2->add_param(model_id => $new_combine_variants_model->id), "added model id");
ok( $pse2->confirmable, "confirmable");
ok( $pse2->confirm, "confirmed");
$bridge = GSC::Sequence::AnalysisOutputPSE->get(pse_id => $pse2->id);
ok($bridge, "got analysis_output_pse");

# Check the next step
ok( $pse2->post_confirm, "post_confirm");
($tpp_bridge_2) = GSC::TppPSE->get(prior_pse_id => $pse2->id);
ok ($tpp_bridge_2, "got the bridge");
($next_pse_2) = GSC::PSE->get($tpp_bridge_2->pse_id);
isa_ok ($next_pse_2, "GSC::PSE::QueueInstrumentDataForGenomeModeling");
$data_directory = "/tmp/test_polyphred_force_genotype_1_25_$ENV{USER}/";
ok($next_pse_2->add_param('data_directory', $data_directory), "added data directory param:$data_directory to pse");
ok($next_pse_2->add_param('subject_name', $subject_name), "added test subject name $subject_name to pse");
ok($next_pse_2->confirm, "Called confirm");
ok($next_pse_2->post_confirm, "Called post_confirm");

$file = $pse2->output_file_name;
ok (-e $file, "$file exists");
$out_obj = $pse2->get_output_file_object($file);
ok (ref $out_obj, "got out obj");

($snps, $indels) =$out_obj->collate_sample_group_mutations;
@variances = (@$snps, @$indels);
ok(@variances, "collatted");

# Test combine variants stuff

# Check the combine variants model
#my $new_combine_variants_model = Genome::Model::CombineVariants->get( name => "$subject_name.combine_variants" );

# Check its children and their params
my @combine_variants_children = $new_combine_variants_model->child_models;
is(@combine_variants_children, 4, "Got (exactly) all 4 combine variants children");

my ($high_count, $low_count, $polyphred_count, $polyscan_count);
for my $combine_variants_child (@combine_variants_children) {
    isa_ok($combine_variants_child, "Genome::Model::PolyphredPolyscan");
    if ($combine_variants_child->sensitivity eq 'high') {
        $high_count++;
    } elsif ($combine_variants_child->sensitivity eq 'low') {
        $low_count++;
    }
    if ($combine_variants_child->technology eq 'polyphred') {
        $polyphred_count++;
    } elsif ($combine_variants_child->technology eq 'polyscan') {
        $polyscan_count++;
    }
}

is ($high_count, 2, "Two of the children are high sensitivity");
is ($low_count, 2, "Two of the children are low sensitivity");
is ($polyphred_count, 2, "Two of the children are polyphred technology");
is ($polyscan_count, 2, "Two of the children are polyscan technology");

my $hq_polyphred_model = $new_combine_variants_model->hq_polyphred_model;
ok ($hq_polyphred_model, "got the hq_polyphred_model via combine variants accessor");
isa_ok ($hq_polyphred_model, "Genome::Model::PolyphredPolyscan");

my $lq_polyphred_model = $new_combine_variants_model->lq_polyphred_model;
ok ($lq_polyphred_model, "got the lq_polyphred_model via combine variants accessor");
isa_ok ($lq_polyphred_model, "Genome::Model::PolyphredPolyscan");

my $hq_polyscan_model = $new_combine_variants_model->hq_polyscan_model;
ok ($hq_polyscan_model, "got the hq_polyscan_model via combine variants accessor");
isa_ok ($hq_polyscan_model, "Genome::Model::PolyphredPolyscan");

my $lq_polyscan_model = $new_combine_variants_model->lq_polyscan_model;
ok ($lq_polyscan_model, "got the lq_polyscan_model via combine variants accessor");
isa_ok ($lq_polyscan_model, "Genome::Model::PolyphredPolyscan");

# dont build for now
=cut 

# Test build... should build all 4 child models and the combine variants model
my $cron = Genome::Model::Command::Services::BuildQueuedInstrumentData->create(test=>1);
ok($cron->execute,"Build Cron command returned true");

# Check the files exist
ok (-s $new_combine_variants_model->hq_genotype_file_for_chromosome(4), "hq genotype file exists");
ok (-s $new_combine_variants_model->lq_genotype_file_for_chromosome(4), "lq genotype file exists");

# test next_xx_genotype calls
my ($hq_annotated_genotype, $lq_annotated_genotype, $hq_genotype, $lq_genotype);
ok($hq_genotype = $new_combine_variants_model->next_hq_genotype, "Ran next_hq_genotype");
ok($lq_genotype = $new_combine_variants_model->next_lq_genotype, "Ran next_lq_genotype");
ok($hq_genotype, "Got the hq_genotype");
ok($lq_genotype, "Got the lq_genotype");
=cut 


# Attempt to clean up after the test...
END {
    push @directories_to_cleanup, $new_combine_variants_model->data_directory if $new_combine_variants_model;
    push @directories_to_cleanup, $hq_polyscan_model->data_directory if $hq_polyscan_model;
    push @directories_to_cleanup, $lq_polyscan_model->data_directory if $lq_polyscan_model;
    push @directories_to_cleanup, $hq_polyphred_model->data_directory if $hq_polyphred_model;
    push @directories_to_cleanup, $lq_polyphred_model->data_directory if $lq_polyphred_model;
    for my $data_directory (@directories_to_cleanup) {
        delete_directory_contents($data_directory);
    }
}

# Delete the directory and recursively delete all subdirs and their contents
sub delete_directory_contents {
    my $directory_or_file = shift;
    chomp($directory_or_file);
    
    # if its a directory, recurse
    if (-d $directory_or_file) {
        my @directory_contents = `ls $directory_or_file`;
        for my $new_directory_or_file (@directory_contents) {
            my $full_path = "$directory_or_file/$new_directory_or_file";
            delete_directory_contents($full_path);
        }
        rmdir($directory_or_file);
    }
    else {
        unlink $directory_or_file;
    }
}


#!/gsc/bin/perl

use strict;
use warnings;

use above 'Genome';

use Test::More tests => 19;
require Genome::Model::Test;

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    use_ok('Genome::Model::Build');
}

#< Mock Model >#
my $model = Genome::Model::Test->create_basic_mock_model(type_name => 'tester');
ok($model, 'Create mock model');

#< Real create >#
my $build = Genome::Model::Build->create(
    model_id => $model->id,
);
ok($build, 'Created build');
isa_ok($build, 'Genome::Model::Build');
is($build->data_directory,$model->data_directory.'/build'. $build->id, 'build directory resolved');
is($build->model->id,$model->id, 'indirect model accessor');

#< Initialize, Fail, Success >#
# event
my $event = Genome::Model::Test->add_mock_event_to_build($build);
ok($event, 'Build event');
$event->event_status('Scheduled');

# do not send the report
my $gss_report = *Genome::Model::Build::generate_send_and_save_report;
no warnings 'redefine';
*Genome::Model::Build::generate_send_and_save_report = sub{ return 1; };
use warnings;

ok($build->initialize, 'Initialize');
is($build->build_status, 'Running', 'Status is Running');
is($model->current_running_build_id, $build->id, 'Current running build id set to build id in initialize');
ok($build->fail([]), 'Fail');
is($build->build_status, 'Failed', 'Status is Failed');
ok($build->success, 'Success');
is($build->build_status, 'Succeeded', 'Status is Succeeded');
ok(!$model->current_running_build_id, 'Current running build id set to undef in success');
is($model->last_complete_build_id, $build->id, 'Last complete build id set to build id in success');

no warnings 'redefine';
*Genome::Model::Build::generate_send_and_save_report = $gss_report;
use warnings;

# Report to addressees
is(
    $build->_get_to_addressees_for_report_generator_class('Genome::Model::Report::BuildInitialized'),
    $ENV{USER}.'@genome.wustl.edu', 
    "reports go to $ENV{USER}",
);
$build->build_event->user_name('apipe'); # check for apipe
is(
    $build->_get_to_addressees_for_report_generator_class('Genome::Model::Report::BuildInitialized'),
    'apipe-run@genome.wustl.edu', 
    'apipe\'s reports go to apipe-run',
);
is(
    $build->_get_to_addressees_for_report_generator_class('Genome::Model::Report::BuildFailed'),
    'apipe-bulk@genome.wustl.edu', 
    'apipe\'s reports go to apipe-bulk',
);

exit;

#$HeadURL$
#$Id$

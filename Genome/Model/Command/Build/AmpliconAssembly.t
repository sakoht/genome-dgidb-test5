#!/gsc/bin/perl

use strict;
use warnings;

use above "Genome";
use Test::More tests => 27;
require File::Path;

use Data::Dumper;

$ENV{UR_DBI_NO_COMMIT} = 1;
$ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;

my $turn_on_messages = 0;

use_ok( 'Genome::Model::AmpliconAssembly');
use_ok( 'Genome::ProcessingProfile::AmpliconAssembly');
use_ok( 'Genome::Model::Build::AmpliconAssembly' );
use_ok( 'Genome::Model::Command::Build' );

my $test_dir = '/gsc/var/cache/testsuite/data/Genome-Model-Command-Build-Amplicon-Assembly';
ok(-d $test_dir, 'Test dir exists');

#< PROCESSOR PROFILE >#
my %pp_params = (
    id => -5000,
    name => '16S Composition-Test 27F to 1391R [AB] (907R)',
    type_name => 'amplicon assembly',
    assembler => 'phredphrap',
    assembly_size => '1364',
    primer_amp_forward => '27F:AGAGTTTGATCCTGGCTCAG',
    primer_amp_reverse => '1391R:GACGGGCGGTGWGTRCA',
    primer_seq_reverse => '907R:CCGTCAATTCCTTTRAGTTT',
    purpose => 'composition',
    region_of_interest => '16S',
    sequencing_center => 'gsc',
    sequencing_platform => 'sanger',
);
my $pp = Genome::ProcessingProfile::AmpliconAssembly->create(%pp_params);
ok($pp, 'Created a processing profile');
isa_ok($pp, 'Genome::ProcessingProfile::AmpliconAssembly');
is($pp->name, $pp_params{name}, "Processing profile is named '$pp_params{name}'");
is($pp->type_name, $pp_params{type_name}, "Processing profile is for '$pp_params{type_name}'");

#< MODEL >#
my $data_dir = "$test_dir/-5000";
File::Path::rmtree($data_dir) if -e $data_dir;
my %model_params = (
    id => -5000,
    genome_model_id => -5000,
    name => 'test_model_name',
    subject_name => '155DA1b',
    subject_type => 'dna_resource_item_name',
    processing_profile_id => $pp->id,
    data_directory => $data_dir,
);
my $model = Genome::Model::AmpliconAssembly->create(%model_params);
ok($model, 'Created a model');
isa_ok($model,'Genome::Model::AmpliconAssembly');
is($pp->name, $pp_params{name}, "Model is named '$model_params{name}'");
is($pp->type_name, $pp_params{type_name}, "Model is a '$pp_params{type_name}'");
my $run_name = '1jan09.1pmaa1';
my $inst_data = Genome::InstrumentData->create(
    run_name => $run_name,
    sequencing_platform => 'sanger',
    seq_id => $run_name,
    sample_name => 'unknown',
    subset_name => 1,
    library_name => 'unknown',
    full_path => "$test_dir/$run_name",
);
ok($inst_data, 'Created instrument data');
my $ida = Genome::Model::InstrumentDataAssignment->create(
    model_id => $model->id,
    instrument_data_id => $inst_data->id,
    first_build_id => 1,
);
ok($ida, sprintf('Linked instrument data assignment (%s) to model (%s)', $inst_data->id, $model->id));

my $build_event = Genome::Model::Command::Build->create(
    model_id => $model->id,
    auto_execute => 0,
);
isa_ok($build_event, 'Genome::Model::Command::Build');
$build_event->queue_error_messages(1);
$build_event->queue_warning_messages(1);
ok($build_event->execute,'Execute build_event');
is($build_event->warning_messages, undef, 'No warning messages for build_event');
$build_event->dump_warning_messages(1);
is($build_event->error_messages, undef, 'No error messages for build_event');
$build_event->dump_error_messages(1);

my @events = sort { $b->genome_model_event_id <=> $a->genome_model_event_id } Genome::Model::Event->get(
    model_id => $model->id,
    build_id => $build_event->build_id,
    event_status => 'Scheduled',
);
my $expected_event_count = 7;
is(@events, $expected_event_count, "Scheduled $expected_event_count events");

for my $event ( @events ) {
    ok($event->execute, sprintf('Executed event (%s %s)', $event->id, $event->event_type))
        or die; # if one of these fails just die
}

# Remove primer fasta files made for processing profile
unlink $pp->sense_primer_fasta;
unlink $pp->anti_sense_primer_fasta;

exit;

#$HeadURL$
#$Id$

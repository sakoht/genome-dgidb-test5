###########################################################################

package Genome::Model::Command::Build::AmpliconAssembly::Test;

use strict;
use warnings;

use base 'Test::Class';

use Test::More;
require File::Path;

use Data::Dumper 'Dumper';

sub import { # set ENVs
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;

    return 1;
}

sub test_class {
    return 'Genome::Model::Command::Build::AmpliconAssembly';
}

sub _mock_model {
    my $self = shift;

    unless ( $self->{_mock_model} ) {
        $self->{_mock_model} = Genome::Model::AmpliconAssembly::Test->create_mock_model
            or die "Can't create mock amplicon assembly model\n";
    }

    return $self->{_mock_model};
}

sub _main_event {
    my ($self, $event) = @_;

    $self->{_main_event} = $event if $event;

    return $self->{_main_event};
}

sub test01_use : Test(6) {
    my $self = shift;

    use_ok('Genome::Model::AmpliconAssembly');
    use_ok('Genome::Model::AmpliconAssembly::Test');
    use_ok('Genome::ProcessingProfile::AmpliconAssembly');
    use_ok('Genome::Model::Build::AmpliconAssembly');
    use_ok('Genome::Model::Command::Build');

    ok($self->_mock_model, 'Got mock model');

    return 1;
}

sub test02_create : Test(5) {
    my $self = shift;

    my $model = $self->_mock_model;
    my $build_event = Genome::Model::Command::Build->create(
        model_id => $model->id,
        auto_execute => 0,
    );
    ok($build_event, 'Create build');
    isa_ok($build_event, 'Genome::Model::Command::Build');

    $build_event->queue_error_messages(1);
    $build_event->queue_warning_messages(1);

    ok($build_event->execute,'Execute build_event');

    is($build_event->warning_messages, undef, 'No warning messages for build_event');
    $build_event->dump_warning_messages(1);
    is($build_event->error_messages, undef, 'No error messages for build_event');
    $build_event->dump_error_messages(1);

    $self->_main_event($build_event);

    return 1;
}

sub test03_verify : Tests {
    my $self = shift;

    my $build_event = $self->_main_event;
    my $model = $self->_mock_model;
    my @events = sort { $b->genome_model_event_id <=> $a->genome_model_event_id } Genome::Model::Event->get(
        model_id => $model->id,
        build_id => $build_event->build_id,
        event_status => 'Scheduled',
    );
    my $expected_event_count = 11;
    is(@events, $expected_event_count, "Scheduled $expected_event_count events");

    # The execution of these events are tested via the unit tests...but you may wanna make sure it works and see the results
    #  of the system running together
    if ( 0 ) {  
        for my $event ( @events ) {
            ok($event->execute, sprintf('Executed event (%s %s)', $event->id, $event->event_type))
                or die; # if one of these fails just die
        }
        #print $build_event->build->data_directory,"\n##### HIT RETURN TO CONTINUE #####\n"; <STDIN>;
    }

    return 1;
}

###########################################################################

package Genome::Model::Command::Build::AmpliconAssembly::TestBase;

use strict;
use warnings;

use base 'Genome::Utility::TestBase';

use Data::Dumper 'Dumper';
use Genome::Model::AmpliconAssembly::Test; # necessary cuz mock objects are in here
use Test::More;

sub params_for_test_class {
    my $self = shift;
    my $model = $self->mock_model;
    return (
        model => $model,
        build => $model->latest_complete_build,
    );
}
sub required_params_for_class { return; }

sub mock_model {
    my $self = shift;

    unless ( $self->{_mock_model} ) {
        $self->{_mock_model} = Genome::Model::AmpliconAssembly::Test->create_mock_model
            or die "Can't create mock amplicon assembly model\n";
    }

    return $self->{_mock_model};
}

sub build {
    return $_[0]->mock_model->latest_complete_build;
}

sub amplicons {
    return $_[0]->build->get_amplicons;
}

# Setup
sub should_copy_traces { 0 }
sub should_copy_edit_dir { 0 }
sub _pre_execute { 1 }

sub test_01_execute : Tests {
    my $self = shift;

    # traces
    if ( $self->should_copy_traces ) {
        ok( 
            Genome::Model::AmpliconAssembly::Test->copy_test_dir(
                'chromat_dir',
                $self->mock_model->latest_complete_build->chromat_dir,
            ),
            "Copy traces"
        ) or die;
    }

    # edit_dir
    if ( $self->should_copy_edit_dir ) {
        ok(
            Genome::Model::AmpliconAssembly::Test->copy_test_dir(
                'edit_dir',
                $self->mock_model->latest_complete_build->edit_dir,
            ),
            "Copy edit_dir"
        ) or die;
    }

    # Overwrite the execute method in the tool, so we don't redunduntly test (if applicable)
    my $class = $self->test_class;
    $class =~ s/Command::Build/Tools/; # get teh tool class
    my $execute; # to save the original execute
    eval "use $class"; # use to see if exists
    no strict 'refs'; # w/ these on, reassigning execute causes errors
    no warnings;
    unless ( $@ ) { # the tool exists, overwrite the execute to a null sub
        $execute = \&{$class.'::execute'};
        *{$class.'::execute'} = sub{ return 1; };
    }

    #ok($self->_pre_execute, 'Pre Execute') or die "Failed method _pre_execute\n";
    ok($self->{_object}->execute, "Execute") or die "Failed execute\n";

    *{$class.'::execute'} = $execute if $execute;

    #print Dumper({event_id=>$self->{_object}->id});
    #print $self->build->data_directory,"\n"; <STDIN>;

    return 1;
}

###########################################################################

package Genome::Model::Command::Build::AmpliconAssembly::AssembleTest;

use strict;
use warnings;

use base 'Genome::Model::Command::Build::AmpliconAssembly::TestBase';

use Data::Dumper 'Dumper';
use Test::More;

sub test_class {
    return 'Genome::Model::Command::Build::AmpliconAssembly::Assemble';
}

###########################################################################

package Genome::Model::Command::Build::AmpliconAssembly::ClassifyTest;

use strict;
use warnings;

use base 'Genome::Model::Command::Build::AmpliconAssembly::TestBase';

use Data::Dumper 'Dumper';
use Test::More;

sub test_class {
    return 'Genome::Model::Command::Build::AmpliconAssembly::Classify';
}

###########################################################################

package Genome::Model::Command::Build::AmpliconAssembly::CleanUpTest;

use strict;
use warnings;

use base 'Genome::Model::Command::Build::AmpliconAssembly::TestBase';

use Data::Dumper 'Dumper';
use Test::More;

sub test_class {
    return 'Genome::Model::Command::Build::AmpliconAssembly::CleanUp';
}

sub should_copy_traces { 1 }
sub should_copy_edit_dir { 1 }

sub test_03_verify : Test(1) {
    my $self = shift;

    my @files_remaining = glob($self->build->edit_dir.'/*');
    is(@files_remaining, 50, "Removed correct number of files");

    return 1;
}

###########################################################################

package Genome::Model::Command::Build::AmpliconAssembly::CollateTest;

use strict;
use warnings;

use base 'Genome::Model::Command::Build::AmpliconAssembly::TestBase';

use Data::Dumper 'Dumper';
use Test::More;

sub test_class {
    return 'Genome::Model::Command::Build::AmpliconAssembly::Collate';
}

###########################################################################

package Genome::Model::Command::Build::AmpliconAssembly::ContaminationScreenTest;

use strict;
use warnings;

use base 'Genome::Model::Command::Build::AmpliconAssembly::TestBase';

use Data::Dumper 'Dumper';
use Test::More;

sub test_class {
    return 'Genome::Model::Command::Build::AmpliconAssembly::ContaminationScreen';
}

###########################################################################

package Genome::Model::Command::Build::AmpliconAssembly::PrepareInstrumentDataTest;

use strict;
use warnings;

use base 'Genome::Model::Command::Build::AmpliconAssembly::TestBase';

use Data::Dumper 'Dumper';
use Test::More;

sub test_class {
    return 'Genome::Model::Command::Build::AmpliconAssembly::PrepareInstrumentData';
}

sub should_copy_traces { 1 }

sub test_03_verify : Test(1) {
    my $self = shift;

    my $fasta_cnt = grep { -s $_->fasta_file } @{$self->amplicons};
    ok($fasta_cnt, 'Prepared instrument data');
    
    return 1;
}

###########################################################################

package Genome::Model::Command::Build::AmpliconAssembly::OrientTest;

use strict;
use warnings;

use base 'Genome::Model::Command::Build::AmpliconAssembly::TestBase';

use Data::Dumper 'Dumper';
use Test::More;

sub test_class {
    return 'Genome::Model::Command::Build::AmpliconAssembly::Orient';
}

###########################################################################

package Genome::Model::Command::Build::AmpliconAssembly::ReportsTest;

use strict;
use warnings;

use base 'Genome::Model::Command::Build::AmpliconAssembly::TestBase';

use Data::Dumper 'Dumper';
use Test::More;

sub test_class {
    return 'Genome::Model::Command::Build::AmpliconAssembly::Reports';
}

sub should_copy_traces { 1 }
sub should_copy_edit_dir { 1 }

sub test_03_verify : Test(1) {
    my $self = shift;

    my @reports = glob($self->build->resolve_reports_directory.'/*');
    is(@reports, 2, "Created 2 reports");

    return 1;
}

###########################################################################

package Genome::Model::Command::Build::AmpliconAssembly::TrimAndScreenTest;

use strict;
use warnings;

use base 'Genome::Model::Command::Build::AmpliconAssembly::TestBase';

use Data::Dumper 'Dumper';
use Test::More;

sub test_class {
    return 'Genome::Model::Command::Build::AmpliconAssembly::TrimAndScreen';
}

sub should_copy_traces { 1 }
sub should_copy_edit_dir { 1 }

sub test_03_verify {#: Test(1) {
    my $self = shift;

    my @reports = glob($self->build->resolve_reports_directory.'/*');
    is(@reports, 2, "Created 2 reports");

    return 1;
}

###########################################################################

package Genome::Model::Command::Build::AmpliconAssembly::VerifyInstrumentDataTest;

use strict;
use warnings;

use base 'Genome::Model::Command::Build::AmpliconAssembly::TestBase';

use Data::Dumper 'Dumper';
use Test::More;

sub test_class {
    return 'Genome::Model::Command::Build::AmpliconAssembly::VerifyInstrumentData';
}

sub test_03_verify : Test(1) {
    my $self = shift;

    my $amplicons = $self->amplicons;
    ok(@$amplicons, 'Verified linking of instrument data');
    
    return 1;
}

1;

=pod

=head1 Tests

=head1 Disclaimer

 Copyright (C) 2006 Washington University Genome Sequencing Center

 This script is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY or the implied warranty of MERCHANTABILITY
 or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public
 License for more details.

=head1 Author(s)

 Eddie Belter <ebelter@watson.wustl.edu>

=cut

#$HeadURL$
#$Id$


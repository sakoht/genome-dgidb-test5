#!/gsc/bin/perl

use strict;
use warnings;
use above "Genome";
use Test::More tests => 10;
use File::Path;

$ENV{UR_DBI_NO_COMMIT} = 1;
$ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;

use_ok ('Genome::Model::Command::Build::CombineVariants::DeriveAssemblyNames');
my $test_dir = File::Temp::tempdir('CombineVariantsTestXXXXX', DIR => '/gsc/var/cache/testsuite/running_testsuites', CLEANUP => 1);

# TODO: replace this model and build with mock objects or something better... but for now...
my $genes = 'EGFR,KIT';
my $pp = Genome::ProcessingProfile::CombineVariants->create(name => "test-combine-variants", limit_genes_to => $genes);
ok ($pp, "Created test processing profile"); 
my $model = Genome::Model::CombineVariants->create(processing_profile_id => $pp->id, subject_type => 'sample_group', data_directory => $test_dir);
ok ($model, "Created test model");
my $build = Genome::Model::Build::CombineVariants->create(model_id => $model->id);
isa_ok ($build, "Genome::Model::Build::CombineVariants");

# Make test dirs
mkdir $test_dir;
ok(-d $test_dir, "made test dir $test_dir"); 
mkdir $build->data_directory;
ok(-d $build->data_directory, "made test dir " . $build->data_directory);

# Test derive
ok(my $derive = Genome::Model::Command::Build::CombineVariants::DeriveAssemblyNames->create
    (model_id => $model->id, build_id => $build->id), 'Created DeriveAssemblyNames object');
isa_ok($derive->build, 'Genome::Model::Build::CombineVariants');
isa_ok($derive, 'Genome::Model::Command::Build::CombineVariants::DeriveAssemblyNames'); 

ok(my @asps = $derive->execute, "Execute worked");

# TODO test for contents of the file to be correct... but data will change...

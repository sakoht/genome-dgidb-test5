#!/gsc/bin/perl

use strict;
use warnings;
use Test::More tests => 9;
use above "Genome";
use File::Copy;
use File::Path;

$ENV{UR_DBI_NO_COMMIT} = 1;
$ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;

use_ok ('Genome::Model::Command::Build::CombineVariants::VerifyAndFixAssembly::SingleAssembly');
my $test_dir = "/tmp/test_verify_and_fix_assembly_single_assembly_$ENV{USER}/";

# TODO: replace this model and build with mock objects or something better... but for now...
my $genes = 'EGFR,KIT';
my $pp = Genome::ProcessingProfile::CombineVariants->create(name => "test-combine-variants", limit_genes_to => $genes);
ok ($pp, "Created test processing profile"); 
my $model = Genome::Model::CombineVariants->create(processing_profile_id => $pp->id, subject_type => 'sample_group', data_directory => $test_dir);
ok ($model, "Created test model");


my $data_dir = '/gsc/var/cache/testsuite/data/Genome-Model-Command-Build-CombineVariants-VerifyAndFixAssembly-SingleAssembly';
my $assembly_name = "TCGA_Production-0001029_17e-Ensembl-50_36l";
my $source_project_dir = "$data_dir/$assembly_name.source";

my $project_dir = "$data_dir/$assembly_name";

ok (-d $source_project_dir, "source assembly directory exists");

system("cp -r $source_project_dir $project_dir");

ok (-d $project_dir, "source assembly dir copied successfully for testing");

my $ace_file = "$project_dir/edit_dir/$assembly_name.ace";

ok (-e $ace_file, "acefile to verify and remake exists");

ok(my $verify = Genome::Model::Command::Build::CombineVariants::VerifyAndFixAssembly::SingleAssembly->create
    (assembly_directory => $project_dir, ace_file => $ace_file, assembly_name => $assembly_name), "Created VerifyAndFixAssembly object");
isa_ok($verify, 'Genome::Model::Command::Build::CombineVariants::VerifyAndFixAssembly::SingleAssembly');

ok($verify->execute, "found error, fixed, and verified ace file!");

# Clean up
rmtree $test_dir;

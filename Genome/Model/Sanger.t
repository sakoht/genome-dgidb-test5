#!/gsc/bin/perl

use strict;
use warnings;
use Data::Dumper;
use above "Genome";
use Test::More skip_all => 'not ready', 'no_plan';
use File::Basename;

use MG::IO::Polyscan;

use FindBin qw($Bin);

$ENV{UR_DBI_NO_COMMIT} = 1;
$ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
my $data_index = 0;
my @sample_data =( 
    [
        {
            chromosome => 3,
            start => 50,
            stop => 50,
            variant_type=> "snp",
            allele1 => 'A',
            allele1_type => 'ref',
            allele2 => 'G' ,
            allele2_type => 'ref',
            genotype => 'AG',
            score => 75,
            hugo_symbol => 'hugo',
            pcr_product_name => 'foo1',
            read_count => 2, 
        },
        {
            chromosome => 1,
            start => 50,
            stop => 50,
            variant_type=> "snp",
            allele1 => 'A',
            allele1_type => 'ref',
            allele2 => 'T' ,
            allele2_type => 'ref',
            genotype => 'AT',
            score => 75,
            hugo_symbol => 'hugo',
            pcr_product_name => 'foo2',
            read_count => 2, 
        },
        {
            chromosome => 1,
            start => 25,
            stop => 25,
            variant_type=> "snp",
            allele1 => 'A',
            allele1_type => 'ref',
            allele2 => 'G' ,
            allele2_type => 'ref',
            genotype => 'AG',
            score => 75,
            hugo_symbol => 'hugo',
            pcr_product_name => 'foo4',
            read_count => 2, 
        },
    ],
    [
        {
            chromosome => 2,
            start => 60,
            stop => 60,
            variant_type=> "snp",
            allele1 => 'A',
            allele1_type => 'ref',
            allele2 => 'G' ,
            allele2_type => 'ref',
            genotype => 'AG',
            score => 75,
            hugo_symbol => 'hugo',
            pcr_product_name => 'foo11',
            read_count => 2, 
        },
        {
            chromosome => 1,
            start => 88,
            stop => 88,
            variant_type=> "snp",
            allele1 => 'A',
            allele1_type => 'ref',
            allele2 => 'G' ,
            allele2_type => 'ref',
            genotype => 'AG',
            score => 75,
            hugo_symbol => 'hugo',
            pcr_product_name => 'foo13',
            read_count => 2, 
        },
        {
            chromosome => 5,
            start => 50,
            stop => 50,
            variant_type=> "snp",
            allele1 => 'A',
            allele1_type => 'ref',
            allele2 => 'G' ,
            allele2_type => 'ref',
            genotype => 'AG',
            score => 75,
            hugo_symbol => 'hugo',
            pcr_product_name => 'foo14',
            read_count => 2, 
        },
        {
            chromosome => 6,
            start => 70,
            stop => 70,
            variant_type=> "snp",
            allele1 => 'A',
            allele1_type => 'ref',
            allele2 => 'G' ,
            allele2_type => 'ref',
            genotype => 'AG',
            score => 75,
            hugo_symbol => 'hugo',
            pcr_product_name => 'foo15',
            read_count => 2, 
        },
    ],
    [
        {
            chromosome => 3,
            start => 50,
            stop => 50,
            variant_type=> "snp",
            allele1 => 'A',
            allele1_type => 'ref',
            allele2 => 'G' ,
            allele2_type => 'ref',
            genotype => 'AG',
            score => 75,
            hugo_symbol => 'hugo',
            pcr_product_name => 'foo1',
            read_count => 2, 
        },
        {
            chromosome => 1,
            start => 50,
            stop => 50,
            variant_type=> "snp",
            allele1 => 'A',
            allele1_type => 'ref',
            allele2 => 'T' ,
            allele2_type => 'ref',
            genotype => 'AT',
            score => 75,
            hugo_symbol => 'hugo',
            pcr_product_name => 'foo2',
            read_count => 2, 
        },
        {
            chromosome => 1,
            start => 50,
            stop => 50,
            variant_type=> "snp",
            allele1 => 'A',
            allele1_type => 'ref',
            allele2 => 'G' ,
            allele2_type => 'ref',
            genotype => 'AG',
            score => 75,
            hugo_symbol => 'hugo',
            pcr_product_name => 'foo3',
            read_count => 1, 
        },
    ],
    [
        {
            chromosome => 1,
            start => 50,
            stop => 50,
            variant_type=> "snp",
            allele1 => 'A',
            allele1_type => 'ref',
            allele2 => 'T' ,
            allele2_type => 'ref',
            genotype => 'AT',
            score => 75,
            hugo_symbol => 'hugo',
            pcr_product_name => 'foo12',
            read_count => 1, 
        },
        {
            chromosome => 1,
            start => 88,
            stop => 88,
            variant_type=> "snp",
            allele1 => 'A',
            allele1_type => 'ref',
            allele2 => 'G' ,
            allele2_type => 'ref',
            genotype => 'AG',
            score => 75,
            hugo_symbol => 'hugo',
            pcr_product_name => 'foo13',
            read_count => 2, 
        },
        {
            chromosome => 6,
            start => 70,
            stop => 70,
            variant_type=> "snp",
            allele1 => 'A',
            allele1_type => 'ref',
            allele2 => 'G' ,
            allele2_type => 'ref',
            genotype => 'AG',
            score => 75,
            hugo_symbol => 'hugo',
            pcr_product_name => 'foo15',
            read_count => 2, 
        },
        {
            chromosome => 6,
            start => 70,
            stop => 70,
            variant_type=> "snp",
            allele1 => 'A',
            allele1_type => 'ref',
            allele2 => 'C' ,
            allele2_type => 'ref',
            genotype => 'AC',
            score => 75,
            hugo_symbol => 'hugo',
            pcr_product_name => 'foo16',
            read_count => 1, 
        },
    ],
);

my $polyscan_model;
my $polyphred_model;
my $composite_model;
my @command_models;

eval{
    $polyscan_model = test_polyscan();
    $polyphred_model = test_polyphred();
    $composite_model = test_composite($polyscan_model, $polyphred_model);
    @command_models = test_command();
};

print $@ if $@;

eval{
    delete_model($polyscan_model) if $polyscan_model;
    delete_model($polyphred_model) if $polyphred_model;
    delete_model($composite_model) if $composite_model;
    foreach (@command_models){
        delete_model($_) if $_;
    }
};

sub test_polyscan{
    return test_type('polyscan');
}

sub test_polyphred{
    return test_type('polyphred');
}

sub test_type{
    my ($type) = @_;
    $type = lc $type;
    my $cap_type = ucfirst $type;
    my $pp_class = "Genome::ProcessingProfile::$cap_type";
    my $profile = $pp_class->create(name => "bar");
    isa_ok($profile, $pp_class);

    my $model_class = "Genome::Model::$cap_type";
    my $model = $model_class->create(
        subject_name => "test",
        sample_name => 'test',
        name => "$type.test",
        processing_profile => $profile,
    );
    isa_ok($model, "Genome::Model::$cap_type");


    my $model_directory = $model->model_directory;
    ok(-d $model_directory, "model_directory $model_directory exists");

    my $pcr_product_genotype_file = $model->pcr_product_genotype_file;

    my $genotype_file = $model->genotype_file;
    
    my @genotypes = test_data();

    $model->add_pcr_product_genotypes(@genotypes);
    
    print "===================pcr1=================\n";
    system "cat $pcr_product_genotype_file";
    print "===================genotype1=================\n";
    system "cat $genotype_file";

    sleep 1;
    my @genotypes2 = test_data();
    $model->add_pcr_product_genotypes(@genotypes2);

    print "===================pcr2=================\n";
    system "cat $pcr_product_genotype_file";
    print "===================genotype2=================\n";
    system "cat $genotype_file";
    
    return $model;
}

sub test_composite{
    my (@chillun) = @_;

    my $polyscan_model;
    my $polyphred_model;
    foreach (@chillun){
        $polyscan_model = $_ if $_->type eq 'polyscan';
        $polyphred_model = $_ if $_->type eq 'polyphred';
    }
    
    my $pp = Genome::ProcessingProfile::SampleGenotype->create(name => "composite_test");
    my $model = Genome::Model::SampleGenotype->create(
                                                        sample_name => "test",
                                                        name => "composite_test_model",
                                                        processing_profile => $pp,
                                                      );
    isa_ok($model, 'Genome::Model::SampleGenotype');

    $model->add_child_model($polyscan_model);
    $model->add_child_model($polyphred_model);
    my @bridges = $model->child_bridges;
    is(scalar(@bridges), scalar(@chillun), "Got the correct number of bridge table entries.");
    my @child_models = $model->child_models;
    is(scalar(@child_models), scalar(@chillun), "Got the correct number of child models.");
    
    #TODO fix these calls to tech_models
    my ($ps_m) = $model->polyscan_models;
    my ($pf_m) = $model->polyphred_models;
    is($ps_m->id, $polyscan_model->id, "polyscan model ids match");
    is($pf_m->id, $polyphred_model->id, "polyphred model ids match");

    my $genotype_file = $model->genotype_file;
    $model->combine_variants;
    ok(-e $genotype_file,"genotype file created");
    
    print "===================sample_genotype=================\n";
    system "cat $genotype_file";

    return $model;
}

sub test_command{
    my $self = shift;
    $data_index = 0;
    my @sample_names = qw(command_test1 command_test2);
    my @data;
    for (1..4){
        push @data, test_data();
    }
    my %hash_phred;
    $hash_phred{$_} = [] foreach @sample_names;
    for (1..3){
        my $data = shift @data;
        push @{$hash_phred{command_test1}}, $data;
    }
    for (1..6){
        my $data = shift @data;
        push @{$hash_phred{command_test2}}, $data;
    }
    my %hash_scan;
    $hash_scan{$_} = [] foreach @sample_names;
    for (1..2){
        my $data = shift @data;
        push @{$hash_scan{command_test1}}, $data;
    }
    for (1..3){
        my $data = shift @data;
        push @{$hash_scan{command_test2}}, $data;
    }
    
    my $command1 = Genome::Model::Command::AddSampleGenotypeData->create(
        technology_type=> 'polyphred',
        process_param_set_id => 9999,
        input_data=> \%hash_scan,
    );
    $command1->execute;

    my $command2 = Genome::Model::Command::AddSampleGenotypeData->create(
        technology_type=> 'polyscan',
        process_param_set_id => 1000,
        input_data=> \%hash_phred,
    );
    $command2->execute;

    my $model1 = Genome::Model::SampleGenotype->get(name=>"command_test1.sample_genotype");
    my $model2 = Genome::Model::SampleGenotype->get(name=>"command_test2.sample_genotype");
    $model1->combine_variants;
    $model2->combine_variants;

    my @model1_chillun = $model1->child_models;
    foreach my $chile (@model1_chillun){
        my $type = $chile->type;
        my $pcr_file = $chile->pcr_product_genotype_file;
        print "============model 1 $type pcr============\n";
        system "cat $pcr_file";
        my $genotype_file = $chile->genotype_file;
        print "============model 1 $type genotype============\n";
        system "cat $genotype_file";
    }
    my $genotype1 = $model1->genotype_file;
    print "===============model 1 genotype=================\n";
    system "cat $genotype1";

    print "\n\n\n";
    
    my @model2_chillun = $model2->child_models;
    foreach my $chile (@model2_chillun){
        my $type = $chile->type;
        my $pcr_file = $chile->pcr_product_genotype_file;
        print "============model 2 $type pcr============\n";
        system "cat $pcr_file";
        my $genotype_file = $chile->genotype_file;
        print "============model 2 $type genotype============\n";
        system "cat $genotype_file";
    }
    my $genotype2 = $model2->genotype_file;
    print "===============model 2 genotype=================\n";
    system "cat $genotype2";


    return ($model1, $model2, @model1_chillun, @model2_chillun);
    
}

sub delete_model{
    my $model = shift;
    my $model_dir = $model->model_directory;
    undef $model;
    print("\nrm -rf:".system "rm -rf $model_dir/*");
    print("\nrmdir:".system "rmdir $model_dir");
}


sub test_data{
    my $ref = $sample_data[$data_index];
    $data_index++;
    return @$ref;
}

=pod

=head1 NAME
ScriptTemplate - template for new perl script

=head1 SYNOPSIS

=head1 DESCRIPTION 

=cut

#$HeadURL$
#$Id$


